<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Menu</title>
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js">
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3cpath fill='%23000000' d='M63.9 14.4C63.1 6.2 56.2 0 48 0s-15.1 6.2-16 14.3L17.9 149.7c-1.3 6-1.9 12.1-1.9 18.2 0 45.9 35.1 83.6 80 87.7L96 480c0 17.7 14.3 32 32 32s32-14.3 32-32l0-224.4c44.9-4.1 80-41.8 80-87.7 0-6.1-.6-12.2-1.9-18.2L223.9 14.3C223.1 6.2 216.2 0 208 0s-15.1 6.2-15.9 14.4L178.5 149.9c-.6 5.7-5.4 10.1-11.1 10.1-5.8 0-10.6-4.4-11.2-10.2L143.9 14.6C143.2 6.3 136.3 0 128 0s-15.2 6.3-15.9 14.6L99.8 149.8c-.5 5.8-5.4 10.2-11.2 10.2-5.8 0-10.6-4.4-11.1-10.1L63.9 14.4zM448 0C432 0 320 32 320 176l0 112c0 35.3 28.7 64 64 64l32 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-448c0-17.7-14.3-32-32-32z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        :root { 
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #7c8aed;
            --secondary: #4299e1;
            --accent: #ed64a6;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --loader-bg: #0f172a;
            --loader-color: #ffffff;
        }

        :root[data-theme="light"] {
            --dark-bg: #ffffff;
            --card-bg: #f8fafc;
            --card-hover: #fff7ed;
            --border: #fed7aa;
            --text: #0f172a;
            --text-muted: #475569;
            --primary: #f97316; 
            --primary-dark: #ea580c;
            --primary-light: #fb923c;
            --gradient-1: linear-gradient(135deg, #f97316 0%, #c2410c 100%);
            --secondary: #334155;
            --accent: #f97316;
            --success: #16a34a; 
            --warning: #d97706;
            --error: #dc2626;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --loader-bg: #ffffff;
            --loader-color: #0f172a;
        }

        [data-theme="light"] .btn-primary,
        [data-theme="light"] .nav-item.active,
        [data-theme="light"] .tab-btn.active,
        [data-theme="light"] .shift-toggle input[type="radio"]:checked + label { color: #ffffff !important; font-weight: 600; }
        [data-theme="light"] .hero-card { box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.4); }
        [data-theme="light"] .btn-skip { background-color: #f59e0b !important; color: #ffffff !important; border: 1px solid #d97706 !important; font-weight: 600; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        [data-theme="light"] .btn-eaten,
        [data-theme="light"] .btn-mark-eaten { background-color: #16a34a !important; color: #ffffff !important; border: 1px solid #15803d !important; font-weight: 600; box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3); }
        [data-theme="light"] .btn-skip:hover,
        [data-theme="light"] .btn-eaten:hover { transform: translateY(-1px); opacity: 0.95; }
        [data-theme="light"] .form-input, 
        [data-theme="light"] .form-select, 
        [data-theme="light"] .form-textarea,
        [data-theme="light"] .search-input { background: #ffffff; border-color: #cbd5e1; color: #0f172a; }
        [data-theme="light"] .search-icon { color: #64748b; }
        [data-theme="light"] #tab-bar { background: rgba(255, 255, 255, 0.95) !important; border-color: var(--border) !important; box-shadow: 0 -4px 20px rgba(0,0,0,0.05) !important; }
        [data-theme="light"] .staff-item { background: #ffffff !important; border: 1px solid var(--border) !important; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        [data-theme="light"] .staff-item .staff-name { color: var(--text) !important; font-weight: 600; }
        [data-theme="light"] .staff-item .staff-dish { color: var(--text-muted) !important; }
        [data-theme="light"] .shift-toggle, 
        [data-theme="light"] thead { background: #fff7ed !important; }
        [data-theme="light"] .shift-toggle label { color: var(--text-muted); }
        [data-theme="light"] .order-dish-list .order-dish-item { background: #fff7ed !important; color: var(--text) !important; }
        [data-theme="light"] .order-dish-list .order-dish-item:hover,
        [data-theme="light"] .order-dish-list .order-dish-item.selected { background: #fed7aa !important; border-color: var(--primary) !important; }
        [data-theme="light"] .form-input, 
        [data-theme="light"] .form-select, 
        [data-theme="light"] .form-textarea,
        [data-theme="light"] .search-input { background: #ffffff !important; border: 1px solid #cbd5e1 !important; color: #0f172a !important; }
        [data-theme="light"] .search-icon { color: #94a3b8 !important; }
        [data-theme="light"] .modal-content { background: #ffffff !important; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        [data-theme="light"] .close-btn { color: #64748b !important; }
        [data-theme="light"] .toggle-option.active { background: var(--primary) !important; color: #ffffff !important; box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);font-weight: 700;}        
        [data-theme="light"] .toggle-group { background: #e2e8f0; }
        [data-theme="light"] #toast-notification { box-shadow: 0 10px 30px rgba(0,0,0,0.15); background: #ffffff; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--dark-bg); color: var(--text); line-height: 1.5; font-size: 14px; }
        #app { max-width: 900px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 100px; }
        @media (min-width: 769px) { #app { padding: 1.5rem; padding-top: 90px; } body { font-size: 13px; } }
        main { flex-grow: 1; padding: 1.5rem 1rem 0; }
        @media (min-width: 769px) { main { padding: 1.5rem 1.5rem 0; } }
        
        .card { background: var(--card-bg); border-radius: var(--radius-md); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); transition: all 0.2s ease; }
        @media (min-width: 769px) { .card { padding: 1.5rem; } }
        .card:hover { box-shadow: var(--shadow-md); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; transition: margin-bottom 0.3s ease; transition: margin-bottom 0.2s ease; }
        .card-header.collapsed { margin-bottom: 0 !important; border-bottom: none; }
        
        .btn-upload { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-upload:hover { background: var(--card-hover); border-color: var(--primary); }

        .toggle-group-container { display: flex; flex-direction: column; gap: 1rem; max-width: 300px; margin: 0 auto 2rem; }
        .toggle-group-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); text-align: center; margin-bottom: 0.5rem; }
        .toggle-group { display: flex; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 50px; border: 1px solid var(--border); position: relative; }
        .toggle-option { flex: 1; padding: 8px 0; text-align: center; font-size: 13px; font-weight: 500; color: var(--text-muted); cursor: pointer; border-radius: 40px; transition: all 0.3s ease; position: relative; z-index: 1; }
        .toggle-option.active { background: var(--card-bg); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: 600; }
        .toggle-option:hover:not(.active) { color: var(--text); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text); }
        @media (min-width: 769px) { .card-title { font-size: 20px; } }

        .gift-alert { background: linear-gradient(to right, rgba(237, 137, 54, 0.15), rgba(237, 100, 166, 0.15)); border: 1px solid var(--warning); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; animation: slideDown 0.5s ease; }
        .gift-alert h3 { color: var(--warning); font-size: 16px; margin-bottom: 0.25rem; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .hero-card { background: var(--gradient-1); position: relative; overflow: hidden; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white !important; }
        .hero-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.7; } }
        .hero-content { position: relative; z-index: 1; width: 100%; }
        .hero-greeting { font-size: 14px; opacity: 0.95; margin-bottom: 6px; color: white !important; }
        .hero-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); color: white !important; }
        .hero-subtitle { font-size: 13px; opacity: 0.9; color: white !important; }
        
        .tabs { display: flex; gap: 6px; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 4px; }
        .tabs::-webkit-scrollbar { height: 3px; }
        .tab-btn { padding: 8px 16px; border-radius: var(--radius-sm); background: var(--card-bg); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; white-space: nowrap; font-weight: 500; font-size: 13px; display: inline-flex; align-items: center; position: relative;}
        .tab-btn.has-order { background: var(--success) !important; border-color: var(--success) !important; color: white !important; }
        
        .tab-btn.has-order::after { display: none; }
        .tab-btn .tab-label { max-width: 0; overflow: hidden; transition: max-width 0.3s ease, margin-left 0.3s ease; }
        .tab-btn.active .tab-label { max-width: 100px; margin-left: 8px; }
        .tab-btn:hover { background: var(--card-hover); color: var(--text); }
        .tab-btn.active { background: var(--primary) !important; border-color: var(--primary) !important; color: white !important; }
        
        .action-buttons-hero { display: flex; gap: 12px; margin-top: 1rem; justify-content: center; }
        .btn-skip { background: var(--warning); color: white; flex: 1; max-width: 150px; }
        .btn-eaten { background: var(--success); color: white; flex: 1; max-width: 150px; }
        .staff-item.skipped { opacity: 0.8; background: rgba(237, 137, 54, 0.1); border-color: var(--warning); }
        .btn-mark-eaten { padding: 6px 12px; font-size: 11px; background: var(--success); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
        
        .department-group { margin-bottom: 0.75rem; }
        .department-header { color: var(--primary); padding: 0.5rem 0 0.25rem; font-size: 14px; font-weight: 600; }
        .skipped-section-header { color: var(--warning); font-size: 15px; font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 8px; }
        
        .order-dish-list { display: grid; gap: 0.5rem; }
        .order-dish-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(102, 126, 234, 0.05); border-radius: var(--radius-sm); border: 1px solid transparent; cursor: pointer; }
        .order-dish-item:hover, .order-dish-item.selected { border-color: var(--primary); background: rgba(102, 126, 234, 0.12); }
        .order-dish-name { flex: 1; font-size: 14px; font-weight: 500; }

        .stats-header { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 1.5rem; }
        .options-btn { width: 44px; height: 44px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text-muted);display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; position: relative; box-shadow: var(--shadow-sm); }
        .options-btn:hover, .options-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .stats-dropdown { position: absolute; top: 55px; left: 0; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 160px; z-index: 100; overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s ease; }
        .stats-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 10px;transition: background 0.2s; }
        .dropdown-item:hover { background: rgba(102, 126, 234, 0.1); color: var(--primary); }
        .dropdown-item.active { background: rgba(102, 126, 234, 0.1); color: var(--primary); font-weight: 700; }
        .dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }

        .date-navigator { display: flex; align-items: center; justify-content: center; gap: 12px; background: var(--card-bg); border: 1px solid var(--border); padding: 4px; border-radius: 12px; flex: 1; max-width: 320px; box-shadow: var(--shadow-sm); height: 44px; }
        
        .nav-arrow-btn { width: 34px; height: 34px; border-radius: 10px; border: none; background: transparent; color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .nav-arrow-btn:hover { background: rgba(102, 126, 234, 0.1); color: var(--primary); }

        .date-display-wrapper { flex: 1; text-align: center; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; height: 100%; }     
        .date-display-text { font-weight: 600; font-size: 14px; color: var(--text); user-select: none;}  
        .hidden-date-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        .today-link { font-size: 13px; color: var(--text-muted); text-decoration: none; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; margin-top: 10px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .today-link:hover { color: var(--primary); background: rgba(102, 126, 234, 0.1); }
        .btn-label-text { display: none; }
        
        @media (min-width: 769px) {
            .btn-label-text { display: inline-block; margin-left: 8px; margin-right: 4px; font-size: 13px; font-weight: 600;}
            .options-btn { width: auto !important; padding: 0 16px !important; justify-content: space-between !important; }
        }     
        
        .staff-list { list-style: none; }
        .staff-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 1rem; background: rgb(25, 34, 49); border-radius: var(--radius-sm); margin-bottom: 4px; border: 1px solid transparent; }
        .staff-item.eaten { opacity: 0.5; }
        .staff-details { flex: 1; }
        .staff-name { font-weight: 500; font-size: 12px; margin-bottom: 2px; }
        .summary-list-item .staff-name { font-size: 12px; font-weight: 500; color: var(--text-muted); }
        .staff-dish { font-size: 14px; color: var(--text-muted); }
        .summary-list-item .staff-dish { font-size: 14px; font-weight: 500; color: var(--text); }
        
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary); margin: 0 auto 1rem; object-fit: cover; display: block; }
        .profile-name { font-size: 20px; font-weight: 600; text-align: center; }
        .profile-depart { font-size: 14px; color: var(--text-muted); text-align: center; margin-bottom: 2rem; }
        .profile-language-toggle { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem; }
        .lang-toggle-btn { min-width: 100px; }
        .lang-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .profile-menu-item { display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; margin: 0 auto; max-width: 210px; transition: all 0.2s ease; }
        .profile-menu-item:hover { background: var(--card-hover); border-color: var(--primary); }
        
        .btn { padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--gradient-1); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-block { width: 100%; }

        .status-icon { display: inline-flex; justify-content: center; align-items: center; width: 28px; height: 28px; border-radius: 50%; font-size: 13px; border: 1px solid transparent; transition: all 0.2s ease; }
        .status-icon-btn { display: inline-flex; justify-content: center; align-items: center; width: 32px; height: 32px; border-radius: 50%; font-size: 14px; border: 1px solid transparent; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;}
        .status-icon-btn:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .status-sun { color: var(--primary); background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2); }
        .status-moon { color: var(--text); background: rgba(128, 128, 128, 0.1); border-color: var(--border); }
        .status-missing { background: var(--warning); color: #fff; border-color: var(--warning); box-shadow: 0 2px 5px rgba(237, 137, 54, 0.3); }
        
        .support-row { cursor: default; } 
        .support-row:hover { background-color: transparent; }
        .support-row td { vertical-align: middle; padding: 12px 8px; }

        .week-detail-container { background: transparent; border: none; border-radius: 0; padding: 0; margin: 0; box-shadow: none; border-bottom: 1px solid var(--border); }
        .week-detail-container:last-child { border-bottom: none; }
        .week-detail-title { font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 0.5rem;}

        .detail-row { background-color: rgba(102, 126, 234, 0.05); }
        .detail-row td { padding: 0 !important; }
        .detail-content { padding: 0; border-top: 1px dashed var(--border); }
        .detail-inner-wrapper { padding: 12px 16px; }

        .admin-action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 1rem; }
        .btn-group-row { display: flex; gap: 8px; }
        .btn-delete-order { background: var(--card-bg); color: var(--error); border: 1px solid var(--error); }
        .btn-delete-order:hover { background: rgba(245, 101, 101, 0.1); }
        
        .mini-dish-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .mini-dish-item { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; background: var(--card-bg); opacity: 1;}
        .mini-dish-item.selected { border-color: var(--primary); background: rgba(102, 126, 234, 0.1); opacity: 1; font-weight: 600;}
        .mini-dish-item:hover:not(.disabled) { opacity: 1; border-color: var(--text-muted); }
        .mini-dish-item.disabled { cursor: not-allowed; opacity: 0.4; background: rgba(0,0,0,0.1); }
        
        .day-block { margin-bottom: 1rem; }
        .day-label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; display: block;}
        .day-label.past { text-decoration: line-through; opacity: 0.7; }

        
        .icon-btn { width: 36px; height: 36px; border-radius: var(--radius-sm); background: var(--card-bg); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .icon-btn:hover { background: var(--card-hover); }

        .gift-actions { margin-top: 0.5rem; display: flex; justify-content: flex-start; } 

        .toggle-icon { transition: transform 0.3s ease; cursor: pointer; margin-left: auto;width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .toggle-icon:hover { background-color: rgba(128, 128, 128, 0.1); }
        .toggle-icon.rotate { transform: rotate(180deg); }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 13px; font-family: inherit; }
        .form-input:focus { border-color: var(--primary); outline: none; }
        
        .search-bar { display: flex; gap: 8px; margin-bottom: 1rem; }
        .search-wrapper { position: relative; flex: 1; }
        .search-input { width: 100%; padding: 10px 12px 10px 38px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); padding: 1.5rem; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); animation: modalSlideIn 0.2s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; }
        
        #tab-bar { position: fixed; bottom: 0.75rem; left: 50%; transform: translateX(-50%); background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 20px; padding: 6px; display: flex; gap: 4px; box-shadow: var(--shadow-lg); z-index: 100; width: calc(100% - 1.5rem); max-width: 400px; }
        @media (min-width: 769px) { #tab-bar { top: 1rem; bottom: auto; border-radius: 24px; padding: 8px; max-width: 500px; } }
        .nav-item { flex: 1; padding: 12px; border-radius: 14px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item.needs-attention::after { content: ''; position: absolute; top: 8px; right: 20px; width: 6px; height: 6px; background: var(--error); border-radius: 50%; animation: pulse-dot 1.5s infinite; }
        .nav-item.active.needs-attention::after { display: none; }
        @keyframes pulse-dot { 0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); } 50% { box-shadow: 0 0 0 5px rgba(245, 101, 101, 0); } }

        #toast-notification { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--card-bg); padding: 10px 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 10px; z-index: 10001; opacity: 0; visibility: hidden; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 250px; max-width: 90vw; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; }
        #toast-notification.success, #toast-notification.error { border-left: none; }
        .toast-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .toast-icon.success { background: linear-gradient(135deg, #48bb78, #2f855a); } 
        .toast-icon.error { background: linear-gradient(135deg, #f56565, #c53030); }
        #toast-notification span { font-weight: 600; font-size: 13px; color: var(--text); }

        @media (max-width: 768px) {
            #toast-notification {
                bottom: 90px !important;
            }
        }
        
        #loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--loader-bg); color: var(--loader-color); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: background-color 0.3s ease, color 0.3s ease; }
        #loader svg path { fill: var(--loader-color) !important; transition: fill 0.3s ease; }        
        .static-logo { width: 180px; max-width: 40%; height: auto; }

        .table-wrapper { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(102, 126, 234, 0.08); }
        th, td { padding: 10px 12px; text-align: left; font-size: 13px; border-top: 1px solid var(--border); }
        th { font-weight: 600; color: var(--primary); text-transform: uppercase; font-size: 12px; }
        .action-buttons { display: flex; gap: 6px; flex-direction: row; }
        
        .shift-toggle { display: flex; gap: 6px; background: rgba(102, 126, 234, 0.08); padding: 4px; border-radius: var(--radius-sm); }
        .shift-toggle input[type="radio"] { display: none; }
        .shift-toggle label { flex: 1; padding: 6px 10px; text-align: center; border-radius: 6px; cursor: pointer; font-weight: 500; color: var(--text-muted); font-size: 13px; transition: all 0.2s; }
        .shift-toggle input[type="radio"]:checked + label { background: var(--primary); color: white; }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; } .text-muted { color: var(--text-muted); }
        .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mb-3 { margin-bottom: 1.5rem; }
        .p-3 { padding: 1.5rem; }
        @media (max-width: 768px) { .hide-mobile { display: none; } }
    </style>
</head>
<body>
    <div id="app">
        <main id="main-content"></main>
        
        <div id="personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h2 id="personnel-modal-title" class="modal-title"></h2><button class="close-btn" data-modal="personnel-modal"><i class="fas fa-times"></i></button></div>
                <input type="hidden" id="personnel-original-email-key">
                <div class="form-group"><label class="form-label">Tên</label><input type="text" id="personnel-name-input" class="form-input"></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" id="personnel-email-input" class="form-input"></div>
                <div class="form-group"><label class="form-label">Phòng ban</label><select id="personnel-depart-select" class="form-select"></select></div>
                <button id="save-personnel-btn" class="btn btn-primary btn-block">Lưu</button>
            </div>
        </div>
        
        <div id="guest-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h2 class="modal-title">Đặt món cho khách</h2><button class="close-btn" data-modal="guest-order-modal"><i class="fas fa-times"></i></button></div>
                <div class="form-group"><label class="form-label">Tên khách</label><input type="text" id="guest-name-input" class="form-input" placeholder="Nhập tên"></div>
                <div class="form-group"><label class="form-label">Phòng ban/Công ty</label><input type="text" id="guest-depart-input" class="form-input" placeholder="Nhập tên công ty"></div>
                <div class="form-group"><label class="form-label">Tuần</label><div class="shift-toggle"><input type="radio" id="guest-week-this" name="guest-week" value="this" checked><label for="guest-week-this">Tuần này</label><input type="radio" id="guest-week-next" name="guest-week" value="next"><label for="guest-week-next">Tuần sau</label></div></div>
                <div id="guest-order-days-container"></div>
                <button id="save-guest-order-btn" class="btn btn-primary btn-block mt-3 hidden">Đặt cho khách</button>
            </div>
        </div>
        
        <div id="reopen-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h2 id="reopen-order-modal-title" class="modal-title"></h2><button class="close-btn" data-modal="reopen-order-modal"><i class="fas fa-times"></i></button></div>
                <p class="text-muted mb-3" id="reopen-order-text"></p>
                <button id="confirm-reopen-order-btn" class="btn btn-primary btn-block">Xác nhận</button>
            </div>
        </div>
        
        <div id="delete-personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h2 class="modal-title">Xóa nhân viên</h2><button class="close-btn" data-modal="delete-personnel-modal"><i class="fas fa-times"></i></button></div>
                <p id="delete-personnel-text" class="text-muted mb-3"></p>
                <div style="display: flex; gap: 12px;"><button class="btn btn-secondary" data-modal="delete-personnel-modal" style="flex: 1;">Hủy</button><button id="confirm-delete-personnel-btn" class="btn btn-primary" style="flex: 1;">Xóa</button></div>
            </div>
        </div>

        <div id="department-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="department-modal-title" class="modal-title"></h2>
                    <button class="close-btn" data-modal="department-modal"><i class="fas fa-times"></i></button>
                </div>
                <input type="hidden" id="department-original-name">
                <div class="form-group">
                    <label class="form-label">Tên phòng ban</label>
                    <input type="text" id="department-name-input" class="form-input" placeholder="Nhập tên phòng ban...">
                </div>
                <button id="save-department-btn" class="btn btn-primary btn-block">Lưu & Đồng bộ</button>
            </div>
        </div>
        
        <div id="delete-department-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Xóa & Chuyển phòng ban</h2>
                    <button class="close-btn" data-modal="delete-department-modal"><i class="fas fa-times"></i></button>
                </div>
                
                <p id="delete-department-text" class="text-muted mb-3" style="font-weight:600; color:var(--text) !important;"></p>
                
                <div class="form-group">
                    <label class="form-label" style="color: var(--warning);">Chọn phòng ban mới cho nhân sự cũ:</label>
                    <select id="transfer-department-select" class="form-select">
                    </select>
                </div>
        
                <div style="background: rgba(102, 126, 234, 0.1); color: var(--primary); padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> Toàn bộ nhân viên và lịch sử đặt món tháng này của phòng ban bị xóa sẽ được chuyển sang phòng ban mới chọn ở trên.
                </div>
        
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" data-modal="delete-department-modal" style="flex: 1;">Hủy</button>
                    <button id="confirm-delete-department-btn" class="btn btn-primary" style="flex: 1;">Xác nhận chuyển & Xóa</button>
                </div>
            </div>
        </div>
        
        <div id="skip-option-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h2 class="modal-title">Nhường suất ăn</h2><button class="close-btn" data-modal="skip-option-modal"><i class="fas fa-times"></i></button></div>
                <p class="text-muted mb-3">Bạn muốn nhường phần ăn này cho ai?</p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button id="skip-everyone-btn" class="btn btn-primary btn-block"><i class="fas fa-users"></i> Nhường cho mọi người</button>
                    <div style="display:flex; align-items:center; gap: 8px; margin: 0.5rem 0; color: var(--text-muted); font-size: 12px;">
                        <span style="flex:1; height:1px; background:var(--border);"></span> HOẶC <span style="flex:1; height:1px; background:var(--border);"></span>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label">Nhường cho người cụ thể</label>
                            <input type="text" id="skip-receiver-input" class="form-input" placeholder="Nhập tên người nhận..." list="staff-suggestions">
                            <datalist id="staff-suggestions"></datalist>
                        </div>
                        <button id="skip-specific-btn" class="btn btn-secondary btn-block">Nhường cho người này</button>
                    </div>
                </div>
            </div>
        </div>

        <nav id="tab-bar" class="hidden"></nav>
        <div id="toast-notification"></div>
        <div id="loader" class="hidden">
            <div class="static-logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 865.5 254.7">
                    <path d="M0,251.3V5.6h55.5v245.8H0Z" fill="#fff"/>
                    <path d="M70.8,251.3V81.9h42.7l5.6,11.8c2.9-2.5,6-4.6,9.1-6.4,3.1-1.8,6.4-3.4,9.7-4.7,3.4-1.3,6.9-2.2,10.7-2.8,3.7-.6,7.6-.8,11.7-.8,11.7,0,21.8,1.8,30.3,5.5,8.5,3.7,15.5,8.9,21,15.6,5.5,6.7,9.6,14.9,12.3,24.5,2.6,9.6,4,20.2,4,31.8v95h-51.1v-93.8c0-5.3-.6-9.8-1.7-13.6-1.1-3.8-2.8-6.9-4.9-9.4-2.1-2.5-4.8-4.3-8-5.5-3.2-1.2-6.9-1.8-11.2-1.8s-8,.6-11.5,1.8c-3.5,1.2-6.5,3.2-9.1,5.9-2.5,2.8-4.6,6.4-6,11-1.5,4.6-2.2,10.2-2.2,16.8v88.5h-51.3,0Z" fill="#fff"/>
                    <path d="M334,5.6c12.9,0,24.3,1.8,34.2,5.2,9.9,3.5,18.3,8.3,25,14.4,6.7,6.1,11.8,13.3,15.3,21.6,3.5,8.3,5.2,17.2,5.2,26.8s-.7,11.8-2.1,17c-1.4,5.3-3.4,10-6.1,14.2-2.7,4.2-5.9,8-9.6,11.2-3.8,3.2-8.1,5.9-13,8,6,2.5,11.3,5.6,16,9.4,4.7,3.8,8.6,8.1,11.8,13,3.2,4.9,5.7,10.3,7.4,16.2,1.7,5.9,2.5,12.3,2.5,19,0,9.8-1.8,19-5.5,27.5-3.7,8.5-9,15.9-15.9,22.1-6.9,6.2-15.4,11.1-25.5,14.6-10,3.6-21.4,5.3-34,5.3h-96.8V5.6h91.1ZM333.5,104.6c3.9,0,7.5-.6,10.7-1.9,3.2-1.2,5.8-2.9,8-5.1,2.2-2.1,3.9-4.6,5-7.4,1.1-2.8,1.7-5.9,1.7-9.1s-.6-6.4-1.8-9.4c-1.2-3-2.9-5.6-5.2-7.8-2.3-2.2-5-3.9-8.3-5.2-3.3-1.3-7-2-11.2-2h-35v47.9h36.1,0ZM337.7,200.2c4.2,0,8-.7,11.3-2s6.3-3.2,8.6-5.4c2.4-2.3,4.2-4.9,5.6-8,1.4-3.1,2-6.4,2-9.9s-.6-6.6-1.7-9.6c-1.1-3-2.8-5.7-5.1-8-2.3-2.3-5-4.1-8.3-5.5-3.3-1.4-7.1-2-11.3-2h-41.5v50.6h40.3Z" fill="#fff"/>
                    <path d="M435.7,132.2c4.7-10.7,11.3-20,19.6-27.9,8.3-7.9,18-14.1,29.2-18.6,11.2-4.5,23.2-6.8,36.2-6.8s25,2.3,36.2,6.8c11.2,4.5,20.9,10.7,29.1,18.6,8.2,7.9,14.8,17.2,19.6,27.9,4.8,10.7,7.2,22.3,7.2,34.7s-2.4,24-7.2,34.7c-4.8,10.7-11.3,20-19.6,27.8-8.2,7.8-18,14-29.2,18.5-11.2,4.5-23.3,6.8-36.3,6.8s-24.9-2.3-36.1-6.8-20.9-10.7-29.2-18.5c-8.3-7.8-14.8-17.1-19.6-27.8-4.7-10.7-7.1-22.3-7.1-34.7s2.4-24,7.1-34.7h0ZM482.2,182.4c2.2,4.8,5.2,8.9,9,12.4,3.8,3.5,8.2,6.3,13.2,8.3,5,2,10.4,3,16.2,3s11.2-1,16.3-3c5.1-2,9.6-4.7,13.4-8.3,3.8-3.5,6.8-7.7,9-12.5,2.2-4.8,3.3-10,3.3-15.5s-1.1-10.9-3.3-15.7c-2.2-4.8-5.2-9-9-12.5-3.8-3.5-8.2-6.3-13.3-8.3-5.1-2-10.5-3-16.2-3s-11.2,1-16.2,3c-5.1,2-9.5,4.7-13.3,8.3-3.8,3.6-6.8,7.7-9,12.5-2.2,4.8-3.3,10-3.3,15.5s1.1,10.9,3.3,15.7h0Z" fill="#fff"/>
                    <path d="M625.4,0l51.3,18.3v233.1h-51.3V0Z" fill="#fff"/>
                    <path d="M865.5,18.3v233.1h-41.5l-5.8-11.3c-2.8,2.4-5.8,4.4-9,6.2-3.2,1.7-6.5,3.2-10.1,4.4-3.6,1.2-7.3,2-11.2,2.5-3.9.5-8,.8-12.3.8-12.5,0-24.1-2.3-34.6-6.8-10.5-4.5-19.7-10.7-27.4-18.7-7.7-7.9-13.8-17.3-18.1-28-4.3-10.7-6.5-22.2-6.5-34.5s2.2-24,6.5-34.7c4.3-10.7,10.3-20,18-27.9,7.7-7.9,16.8-14.1,27.5-18.6,10.7-4.5,22.2-6.8,34.6-6.8s7.3.2,10.7.7c3.4.5,6.8,1.2,10,2.1,3.2,1,6.3,2.2,9.2,3.6,2.9,1.5,5.8,3.2,8.5,5.2V0l51.3,18.3h0ZM812.5,149c-1.8-4.9-4.4-9-7.7-12.4-3.3-3.3-7.3-5.9-12-7.6-4.7-1.8-9.9-2.6-15.5-2.6s-10.8,1-15.4,3c-4.6,2-8.6,4.7-11.9,8.2-3.3,3.5-5.9,7.6-7.8,12.4-1.9,4.8-2.8,10-2.8,15.7s.9,10.9,2.7,15.7c1.8,4.9,4.4,9.1,7.8,12.6,3.4,3.5,7.4,6.3,12,8.3,4.6,2,9.8,3,15.4,3s10.8-.9,15.5-2.6c4.7-1.7,8.7-4.3,12-7.7s5.9-7.6,7.7-12.5c1.8-5,2.7-10.5,2.7-16.8s-.9-11.8-2.7-16.7h0Z" fill="#fff"/>
                </svg> menu
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        const SUPPORT_EMAIL = 'truc.tran@inbold.com'; // email người hỗ trợ

        const state = {
            isEditingMenu: false,
            personnelViewMode: 'staff',
            adminMenuTab: 'this',
            currentUser: null, staffProfile: null, isAdmin: false,
            currentTab: 'today', adminSubTab: 'stats', authReady: false,
            menuFilterMode: 'auto', orderSelection: {},
            currentOrderDay: 'mon', userShiftSelection: 'morning',
            guestCurrentOrderDay: 'mon', guestShiftSelection: 'morning',
            reopenTarget: { key: null, name: null, weekStr: null }, deleteTarget: { key: null, name: null },
            statsViewMode: 'day', statsViewDate: new Date(), guestOrderSelection: {},
            reopenTargetWeek: null, reopenIsCurrentWeek: false 
        };

        const loadXLSXLibrary = () => {
            return new Promise((resolve, reject) => {
                if (window.XLSX) return resolve();
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
        
        const t = {
            vi: {
                welcome: 'Chào mừng!', pleaseLogin: 'Vui lòng đăng nhập', login: 'Đăng nhập',
                hi: 'Chào', weekend: 'Cuối tuần vui vẻ!', todayMeal: 'Món ăn hôm nay của bạn',
                notOrdered: 'Chưa đặt món', notOrderedDesc: 'Bạn chưa đặt món cho hôm nay',
                orderedWeek: 'Món đã đặt tuần', orderForWeek: 'Đặt món tuần', complete: 'Hoàn tất',
                rest: 'Nghỉ', todayList: 'Danh sách hôm nay', searchStaff: 'Tìm nhân viên...',
                noData: 'Chưa có dữ liệu.', notFound: 'Không tìm thấy.', morning: 'Ca sáng',
                evening: 'Ca chiều', profile: 'Hồ sơ', notUpdated: 'Chưa cập nhật',
                vietnamese: 'Tiếng Việt', english: 'English', support: 'Hỗ trợ', logout: 'Đăng xuất',
                logoutConfirm: 'Bạn có muốn đăng xuất?', loggedOut: 'Đã đăng xuất',
                changeLangSuccess: 'Đổi ngôn ngữ thành công', error: 'Lỗi',
                orderSuccess: 'Đặt món thành công!', orderFailed: 'Đặt món thất bại',
                notOrderedYet: 'Chưa đặt món', everyoneOrdered: 'Mọi người đã đặt món.',
                orderForGuest: 'Đặt cho khách', addGuest: 'Đặt món cho khách',
                guestNamePlaceholder: 'Nhập tên', department: 'Phòng ban',
                guestDepartPlaceholder: 'Nhập tên công ty', shift: 'Ca ăn', thisWeek: 'Tuần này',
                nextWeek: 'Tuần sau', noMenu: 'Chưa có thực đơn.', noDishes: 'Không có món nào.',
                reopenOrderFor: 'Mở lại đặt món cho', reopenConfirmText: 'Thao tác này sẽ cho phép người này đặt lại món.',
                confirm: 'Xác nhận', reopenSuccess: 'Đã mở lại đặt món',
                stats: 'Thống kê', day: 'Ngày', week: 'Tuần', month: 'Tháng',
                ordered: 'Đã đặt', eaten: 'Ăn', notEaten: 'Chưa ăn', dish: 'Món ăn',
                total: 'Tổng', downloadXLSX: 'Tải XLSX', menu: 'Thực đơn',
                menuThisWeek: 'Tuần này', menuNextWeek: 'Tuần sau', noDishYet: 'Chưa có món',
                saveMenu: 'Lưu menu cho tuần sau', personnel: 'Nhân sự', name: 'Tên',
                email: 'Email', actions: ' ', save: 'Lưu',
                addDish: 'Thêm món', removedDish: 'Đã xóa món ăn', added: 'Đã thêm',
                dishes: 'món', exportPersonnel: 'Export nhân sự', mon: 'Thứ 2',
                tue: 'Thứ 3', wed: 'Thứ 4', thu: 'Thứ 5', fri: 'Thứ 6',
                menuSaved: 'Đã lưu thực đơn', unknown: 'Chưa rõ', today: 'Hôm nay',
                oneDishPerLine: 'Tên món tiếng việt | Tên món tiếng anh', 
                skip: 'Nhường', skipped: 'Đã nhường', skipSuccess: 'Đã nhường suất ăn', eatenSuccess: 'Đã xác nhận ăn', 
                skippedList: 'Danh sách đã nhường', addPersonnel: 'Thêm nhân viên', editPersonnel: 'Chỉnh sửa nhân viên', deletePersonnel: 'Xóa nhân viên',
                deleteConfirm: 'Bạn có chắc chắn muốn xóa?', personnelAdded: 'Đã thêm nhân viên', personnelUpdated: 'Đã cập nhật nhân viên',
                personnelDeleted: 'Đã xóa nhân viên', emailExists: 'Email này đã tồn tại', invalidEmail: 'Email không hợp lệ', fillAllFields: 'Vui lòng điền đầy đủ thông tin',
                enterDepartment: 'Nhập tên phòng ban mới', cancel: 'Hủy',
                youGotGift: 'Bạn được nhường suất ăn!', giftPrivate: 'nhường riêng cho bạn', confirmEat: 'Xác nhận ăn phần này',
                notOrderedThisWeek: 'Chưa đặt món tuần này', contactSupport: 'Liên hệ bộ phận hỗ trợ để được mở lại đặt món.',
                cannotOrder: 'Không thể đặt món', weekEnded: 'Tuần này đã kết thúc.', orderExtra: 'Đặt món bổ sung',
                orderFromTo: 'Đặt món từ', to: 'đến', everyone: 'Mọi người', editAgain: 'Chỉnh sửa lại',
                menuSavedState: 'Menu đã được lưu.', otherNew: 'Khác (nhập mới)', enterReceiverName: 'Vui lòng nhập tên người nhận',
                giftAccepted: 'Đã xác nhận ăn món được nhường!', whoToSkip: 'Bạn muốn nhường phần ăn này cho ai?',
                skipForEveryone: 'Nhường cho mọi người', skipForSpecific: 'Nhường cho người cụ thể',
                skipForThisPerson: 'Nhường cho người này', receiverNamePlaceholder: 'Nhập tên người nhận...'
            },
            en: {
                welcome: 'Welcome!', pleaseLogin: 'Please login', login: 'Login',
                hi: 'Hi', weekend: 'Enjoy your weekend!', todayMeal: 'Your meal today',
                notOrdered: 'Not ordered', notOrderedDesc: 'You haven\'t ordered for today',
                orderedWeek: 'Ordered for week', orderForWeek: 'Order for week', complete: 'Complete',
                rest: 'Off', todayList: 'Today\'s List', searchStaff: 'Search staff...',
                noData: 'No data yet.', notFound: 'Not found.', morning: 'Morning shift',
                evening: 'Evening shift', profile: 'Profile', notUpdated: 'Not updated',
                vietnamese: 'Tiếng Việt', english: 'English', support: 'Support', logout: 'Logout',
                logoutConfirm: 'Do you want to logout?', loggedOut: 'Logged out',
                changeLangSuccess: 'Language changed successfully', error: 'Error',
                orderSuccess: 'Order successful!', orderFailed: 'Order failed',
                notOrderedYet: 'Not ordered yet', everyoneOrdered: 'Everyone has ordered.',
                orderForGuest: 'Order for guest', addGuest: 'Order for guest',
                guestNamePlaceholder: 'Enter name', department: 'Department',
                guestDepartPlaceholder: 'Enter company name', shift: 'Shift', thisWeek: 'This week',
                nextWeek: 'Next week', noMenu: 'No menu available.', noDishes: 'No dishes.',
                reopenOrderFor: 'Reopen order for', reopenConfirmText: 'This action will allow this person to re-order.',
                confirm: 'Confirm', reopenSuccess: 'Order reopened',
                stats: 'Statistics', day: 'Day', week: 'Week', month: 'Month',
                ordered: 'Ordered', eaten: 'Ate', notEaten: 'Not eaten', dish: 'Dish',
                total: 'Total', downloadXLSX: 'Download XLSX', menu: 'Menu',
                menuThisWeek: 'This week', menuNextWeek: 'Next week', noDishYet: 'No dishes yet',
                saveMenu: 'Save menu for next week', personnel: 'Personnel', name: 'Name',
                email: 'Email', actions: ' ', save: 'Save',
                addDish: 'Add dish', removedDish: 'Dish removed', added: 'Added',
                dishes: 'dishes', exportPersonnel: 'Export personnel', mon: 'Monday',
                tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday',
                menuSaved: 'Menu saved', unknown: 'Unknown', today: 'Today',
                oneDishPerLine: 'Name of dish in Vietnamese | Name of dish in English', 
                skip: 'Give', skipped: 'Given', skipSuccess: 'Given', eatenSuccess: 'Confirmed eaten',
                skippedList: 'Given meals list', addPersonnel: 'Add personnel', editPersonnel: 'Edit personnel',
                deletePersonnel: 'Delete personnel', deleteConfirm: 'Are you sure you want to delete?',
                personnelAdded: 'Personnel added', personnelUpdated: 'Personnel updated',
                personnelDeleted: 'Personnel deleted', emailExists: 'Email already exists',
                invalidEmail: 'Invalid email', fillAllFields: 'Please fill all fields',
                enterDepartment: 'Enter new department name', cancel: 'Cancel',
                youGotGift: 'You received a meal gift!', giftPrivate: 'gave you specifically', confirmEat: 'Confirm eating this',
                notOrderedThisWeek: 'Not ordered for this week', contactSupport: 'Contact support to reopen ordering.',
                cannotOrder: 'Cannot order', weekEnded: 'This week has ended.', orderExtra: 'Supplementary order',
                orderFromTo: 'Order from', to: 'to', everyone: 'Everyone', editAgain: 'Edit again',
                menuSavedState: 'Menu has been saved.', otherNew: 'Other (enter new)', enterReceiverName: 'Please enter receiver name',
                giftAccepted: 'Gift meal confirmed eaten!', whoToSkip: 'Who do you want to give this meal to?',
                skipForEveryone: 'Give to everyone', skipForSpecific: 'Give to specific person',
                skipForThisPerson: 'Give to this person', receiverNamePlaceholder: 'Enter receiver name...'
            }
        };
        
        const __ = (key) => {
            const lang = (state.staffProfile?.lan || 'vi').startsWith('en') ? 'en' : 'vi';
            return t[lang][key] || key;
        };

        const el = (id) => document.getElementById(id);

        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getWeeksInMonth = (date) => {
            const weeks = new Set();
            const year = date.getFullYear();
            const month = date.getMonth();
            
            let d = new Date(year, month, 1);
            
            while (d.getMonth() === month) {
                weeks.add(getWeekString(d));
                d.setDate(d.getDate() + 7);
            }
            weeks.add(getWeekString(new Date(year, month + 1, 0)));
            
            return Array.from(weeks);
        };
        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        const showLoader = () => el('loader').classList.remove('hidden');
        const hideLoader = () => el('loader').classList.add('hidden');
        const emailToKey = (email) => email.replace(/[.@]/g, '_');
        
        const parseDishValue = (rawString) => {
            if (!rawString) return { status: 'not', dish: '' };

            if (rawString.startsWith('[ignore]')) {
                let cleanDish = rawString.substring(8).trim(); 
                return { status: 'ignore', dish: cleanDish };
            }

            if (rawString.startsWith('giveup[')) {
                const closeBracket = rawString.indexOf(']');
                const receiver = rawString.substring(7, closeBracket);
                const dish = rawString.substring(closeBracket + 2).trim();
                return { status: 'giveup', receiver, dish };
            }

            const prefixes = ['eaten:', 'giveup:', 'not:', 'placeholder:'];
            for (const prefix of prefixes) {
                if (rawString.startsWith(prefix)) {
                    let status = prefix.replace(':', '');
                    if (status === 'placeholder') status = 'ignore';
                    
                    return { 
                        status: status, 
                        dish: rawString.substring(prefix.length).trim() 
                    };
                }
            }

            return { status: 'not', dish: rawString };
        };

        const parseDish = (rawString) => {
            const { dish } = parseDishValue(rawString);
            if (!dish) return '';
            
            let displayDish = dish.replace('[ignore]', '').trim();
            
            const parts = displayDish.split('|');
            const lang = state.staffProfile?.lan || 'vi';
            return (lang.startsWith('en') && parts.length > 1) ? parts[1].trim() : parts[0].trim();
        };
        
        const getFirstName = (fullName) => {
            if (!fullName) return '';
            const parts = fullName.trim().split(' ');
            return (state.staffProfile?.lan || 'vi').startsWith('vi') ? parts[parts.length - 1] : parts[0];
        };
        const showToast = (message, type = 'success') => {
            const toast = el('toast-notification');
            const iconMap = { success: 'check', error: 'times', info: 'info' };
            toast.className = '';
            void toast.offsetWidth;
            toast.innerHTML = `<div class="toast-icon ${type}"><i class="fas fa-${iconMap[type]}"></i></div><span style="font-weight:600">${message}</span>`;
            toast.className = `show ${type}`;
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { 
                toast.classList.remove('show'); 
            }, 1750);
        };

        async function getDocument(collection, documentId) {
            const docRef = doc(db, collection, documentId);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        }

        async function render() {
            if (!state.authReady || !state.staffProfile) { hideLoader(); return; }
            showLoader();
            try {
                switch (state.currentTab) {
                    case 'today': await renderToday(); break;
                    case 'menu': await renderMenu(); break;
                    case 'profile': await renderProfile(); break;
                    case 'admin': await renderAdmin(); break;
                }
            } catch (error) {
                console.error('Render error:', error);
                el('main-content').innerHTML = `<div class="card text-center" style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> Có lỗi xảy ra.</div>`;
            }
            hideLoader();
        }

        async function renderToday() {
            const dayKey = getDayKey();
            const firstName = getFirstName(state.staffProfile.name);
            const userEmailKey = emailToKey(state.currentUser.email);
            
            const currentWeekString = getWeekString(new Date());
            const nextWeekString = getWeekString(new Date(new Date().getTime() + 7 * 86400000));
            
            const [weekData, nextWeekData] = await Promise.all([
                getDocument('order_list', currentWeekString),
                getDocument('order_list', nextWeekString)
            ]);
            
            const userData = weekData ? weekData[userEmailKey] : null;
            const nextUserData = nextWeekData ? nextWeekData[userEmailKey] : null;

            let giftHTML = '';
            if (weekData) {
                const myName = state.staffProfile.name;
                const gifters = [];
                Object.entries(weekData).forEach(([key, val]) => {
                    if (key === 'menu' || key === userEmailKey) return; 
                    const raw = val[dayKey];
                    if (!raw) return;
                    const { status, receiver, dish } = parseDishValue(raw);
                    if (status === 'giveup' && receiver === myName) {
                        gifters.push({ key: key, name: val.name, dish: parseDish(raw), rawDish: dish });
                    }
                });
                if (gifters.length > 0) {
                    giftHTML = gifters.map(g => 
                        `<div class="gift-alert">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div><h3><i class="fas fa-gift"></i> ${__('youGotGift')}</h3><div style="font-size:13px"><strong>${g.name}</strong> ${__('giftPrivate')}: ${g.dish}</div></div>
                            </div>
                            <div class="gift-actions"><button class="btn btn-mark-eaten" style="background:var(--success); padding:6px 12px; font-size:12px;" data-action="eat-gift" data-giver-key="${g.key}" data-day="${dayKey}" data-dish="${g.rawDish}"><i class="fas fa-utensils"></i> ${__('confirmEat')}</button></div>
                        </div>`
                    ).join('');
                }
            }
            
            // Logic tách biệt hoàn toàn Reopen
            let reopenWeekStr = null;
            let isCurrentWeek = false;

            // Ưu tiên check tuần hiện tại trước
            if (userData && userData.order === 'reopen') {
                reopenWeekStr = currentWeekString;
                isCurrentWeek = true;
            } else if (nextUserData && nextUserData.order === 'reopen') {
                reopenWeekStr = nextWeekString;
                isCurrentWeek = false;
            }
            
            if (reopenWeekStr) {
                state.reopenTargetWeek = reopenWeekStr;
                state.reopenIsCurrentWeek = isCurrentWeek; // Lưu trạng thái

                const titleText = isCurrentWeek 
                    ? `Đặt món bổ sung (${reopenWeekStr.split('_')[1]})` 
                    : `Đặt món tuần sau (${reopenWeekStr.split('_')[1]})`;

                const heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${__('hi')} ${firstName}</div><div class="hero-title">${titleText}</div><div class="hero-subtitle">Vui lòng chọn món và xác nhận lại</div></div></div>`;
                el('main-content').innerHTML = heroHtml + `<div id="order-section-container"></div>`;
                await renderReopenOrderSection(el('order-section-container'), reopenWeekStr, isCurrentWeek);
                return;
            }
            
            // Logic mặc định (khi không reopen)
            let heroHtml = '';
            if (['sun', 'sat'].includes(dayKey)) {
                heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${__('hi')} ${firstName}</div><div class="hero-title">${__('weekend')}</div></div></div>`;
            } else {
                const rawDishString = userData ? userData[dayKey] : null;
                if (rawDishString) {
                    const { status, dish } = parseDishValue(rawDishString);
                    const isSkipped = status === 'giveup';
                    const isEaten = status === 'eaten';
                    const isPlaceholder = status === 'ignore' || status === 'placeholder';

                    heroHtml = `<div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">${__('hi')} ${firstName}</div>
                            <div class="hero-title">${parseDish(rawDishString)}</div>
                            ${!isPlaceholder ? `<div class="action-buttons-hero">
                                <button class="btn btn-skip ${isSkipped ? 'active' : ''}" data-action="skip-modal" data-dish="${dish}" data-day="${dayKey}" ${isSkipped || isEaten ? 'disabled' : ''}><i class="fas fa-ban"></i> ${__('skip')}</button>
                                <button class="btn btn-eaten ${isEaten ? 'active' : ''}" data-action="eaten" data-day="${dayKey}" ${isEaten ? 'disabled' : ''}><i class="fas fa-check"></i> ${__('eaten')}</button>
                            </div>` : ''}
                        </div>
                    </div>`;
                } else {
                    heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${__('hi')} ${firstName}</div><div class="hero-title">${__('notOrdered')}</div><div class="hero-subtitle">${__('notOrderedDesc')}</div></div></div>`;
                }
            }
            el('main-content').innerHTML = heroHtml + giftHTML + `<div id="order-section-container"></div>`;
            await renderOrderSection(el('order-section-container'));
        }
        
        async function renderOrderSection(container) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const hour = today.getHours();
            const userEmailKey = emailToKey(state.currentUser.email);
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const dayNames = { mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') };
        
            const isCurrentWeekPeriod = (dayOfWeek >= 1 && dayOfWeek <= 3) || (dayOfWeek === 4 && hour < 15);
            const currentWeekString = getWeekString(today);
            const nextWeekString = getWeekString(new Date(today.getTime() + 7 * 86400000));
            
            const [currentWeekDoc, nextWeekDoc] = await Promise.all([
                getDocument('order_list', currentWeekString),
                getDocument('order_list', nextWeekString)
            ]);

            const userDataCurrent = currentWeekDoc ? currentWeekDoc[userEmailKey] : null;
            const hasOrderedCurrentWeek = userDataCurrent && userDataCurrent.order === 'ordered';
            
            let htmlContent = '';

            if (hasOrderedCurrentWeek) {
                let summaryHTML = `<div class="card"><div class="card-header toggle-card-header" data-target="summary-list-current"><h2 class="card-title">${__('orderedWeek')} ${currentWeekString.split('_')[1]}</h2><i class="fas fa-chevron-up toggle-icon rotate"></i></div><ul id="summary-list-current" class="staff-list hidden">`;
                for (const key of dayKeys) {
                    const rawDish = userDataCurrent[key];
                    if (rawDish) summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[key]}</div><div class="staff-dish">${parseDish(rawDish)}</div></div></li>`;
                    else summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[key]}</div><div class="staff-dish text-muted">${__('notOrdered')}</div></div></li>`;
                }
                htmlContent += summaryHTML + `</ul></div>`;
            } else if (isCurrentWeekPeriod) {
                htmlContent += `<div class="card text-center" style="padding: 2rem;"><i class="fas fa-calendar-xmark" style="font-size: 48px; color: var(--text-muted); margin-bottom: 1rem;"></i><h3 style="color: var(--text); margin-bottom: 0.5rem;">${__('notOrderedThisWeek')}</h3><p class="text-muted" style="margin-bottom: 1.5rem;">${__('contactSupport')}</p><a href="mailto:${SUPPORT_EMAIL}" class="btn btn-primary" style="text-decoration: none;"><i class="fas fa-headset"></i> ${__('support')}</a></div>`;
            }

            if (!isCurrentWeekPeriod) {
                const userDataNext = nextWeekDoc ? nextWeekDoc[userEmailKey] : null;
                const hasOrderedNextWeek = userDataNext && userDataNext.order === 'ordered';

                if (hasOrderedNextWeek) {
                    let summaryHTML = `<div class="card"><div class="card-header toggle-card-header" data-target="summary-list-next"><h2 class="card-title">${__('orderedWeek')} ${nextWeekString.split('_')[1]}</h2><i class="fas fa-chevron-up toggle-icon rotate"></i></div><ul id="summary-list-next" class="staff-list hidden">`;
                    for (const key of dayKeys) {
                        const rawDish = userDataNext[key];
                        summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[key]}</div><div class="staff-dish">${parseDish(rawDish) || __('rest')}</div></div></li>`;
                    }
                    htmlContent += summaryHTML + `</ul></div>`;
                } 
                else {
                    const allSelected = dayKeys.every(day => state.orderSelection[day]);
                    if (allSelected) {
                        let summaryHTML = `<div class="card"><div class="card-header toggle-card-header" data-target="summary-list-confirm"><h2 class="card-title">${__('orderedWeek')} ${nextWeekString.split('_')[1]}</h2><i class="fas fa-chevron-up toggle-icon"></i></div><ul id="summary-list-confirm" class="staff-list">`;
                        for (const dayKey of dayKeys) { summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[dayKey]}</div><div class="staff-dish">${parseDish(state.orderSelection[dayKey])}</div></div></li>`; }
                        htmlContent += summaryHTML + `</ul><button id="submit-order-btn" class="btn btn-primary btn-block mt-3"><i class="fas fa-check"></i> ${__('complete')}</button></div>`;
                    } else {
                        const menu = nextWeekDoc ? nextWeekDoc.menu : null;
                        if (!menu) { 
                            htmlContent += `<div class="card text-center"><p class="text-muted">${__('noMenu')}</p></div>`; 
                        } else {
                            const shiftToggleHTML = `<div class="form-group"><div class="shift-toggle"><input type="radio" id="user-shift-m" name="user-shift" value="morning" ${state.userShiftSelection === 'morning' ? 'checked' : ''}><label for="user-shift-m">${__('morning')}</label><input type="radio" id="user-shift-e" name="user-shift" value="evening" ${state.userShiftSelection === 'evening' ? 'checked' : ''}><label for="user-shift-e">${__('evening')}</label></div></div>`;
                            
                            let tabsHTML = `<div class="tabs">`;
                            for (const dayKey of dayKeys) { 
                                const hasOrder = state.orderSelection[dayKey];
                                tabsHTML += `<button class="tab-btn order-day-tab-btn ${state.currentOrderDay === dayKey ? 'active' : ''} ${hasOrder ? 'has-order' : ''}" data-day-key="${dayKey}">${dayNames[dayKey]}</button>`; 
                            }
                            tabsHTML += `</div>`;
                            
                            let daysContentHTML = '';
                            for (const dayKey of dayKeys) {
                                const dishes = menu[dayKey] || [];
                                daysContentHTML += `<div id="order-day-${dayKey}" class="${state.currentOrderDay === dayKey ? '' : 'hidden'}">`;
                                const selectedDish = state.orderSelection[dayKey];
                                if (Array.isArray(dishes) && dishes.length > 0) { 
                                    daysContentHTML += `<div class="order-dish-list">${dishes.map(dish => {
                                        const isSelected = dish === selectedDish;
                                        return `<div class="order-dish-item ${isSelected ? 'selected' : ''}" data-dish="${dish}" data-day-key="${dayKey}"><div class="order-dish-name">${parseDish(dish)}</div></div>`;
                                    }).join('')}</div>`; 
                                } else { 
                                    daysContentHTML += `<p class="text-center text-muted p-3">${__('noDishes')}</p><div class="order-dish-list"><div class="order-dish-item" data-dish="Nghỉ" data-day-key="${dayKey}"><div class="order-dish-name">${__('rest')}</div></div></div>`; 
                                }
                                daysContentHTML += `</div>`;
                            }
                            htmlContent += `<div class="card"><div class="card-header"><h2 class="card-title">${__('orderForWeek')} ${nextWeekString.split('_')[1]}</h2></div>${shiftToggleHTML}${tabsHTML}${daysContentHTML}</div>`;
                        }
                    }
                }
            }

            container.innerHTML = htmlContent;
        }
        
        async function renderReopenOrderSection(container, targetWeekString, isCurrentWeek) {
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const dayNames = { mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') };
            const userEmailKey = emailToKey(state.currentUser.email);
            
            // Xử lý logic ngày để khóa các ngày đã qua
            const today = new Date();
            const currentDayIndex = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            const dayMap = { mon: 1, tue: 2, wed: 3, thu: 4, fri: 5 };
            
            // Lấy dữ liệu cũ để hiển thị cho các ngày bị khóa
            const weekDoc = await getDocument('order_list', targetWeekString);
            const menu = weekDoc ? weekDoc.menu : null;
            const existingUserOrder = weekDoc && weekDoc[userEmailKey] ? weekDoc[userEmailKey] : {};

            if (!menu) { container.innerHTML = `<div class="card text-center"><p class="text-muted">${__('noMenu')}</p></div>`; return; }

            // Tìm ngày đầu tiên chưa bị khóa để hiển thị mặc định
            if (!state.currentOrderDay || !dayKeys.includes(state.currentOrderDay)) {
                 if (isCurrentWeek) {
                     // Tìm ngày đầu tiên trong tương lai (hoặc hôm nay)
                     const nextAvailable = dayKeys.find(d => dayMap[d] >= currentDayIndex);
                     state.currentOrderDay = nextAvailable || 'fri';
                 } else {
                     state.currentOrderDay = 'mon';
                 }
            }

            // Kiểm tra điều kiện hoàn thành (chỉ cần chọn đủ các ngày TƯƠNG LAI)
            // Lấy danh sách các ngày cần phải chọn (là ngày tương lai)
            const requiredDays = isCurrentWeek 
                ? dayKeys.filter(d => dayMap[d] >= currentDayIndex) 
                : dayKeys;

            const allRequiredSelected = requiredDays.every(day => state.orderSelection[day]);

            if (allRequiredSelected) {
                // Hiển thị tóm tắt trước khi gửi
                let summaryHTML = `<div class="card"><div style="background: var(--warning); color: white; padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 1rem; text-align: center;"><i class="fas fa-info-circle"></i> Xác nhận lại các món</div><div class="card-header"><h2 class="card-title">${__('orderedWeek')} ${targetWeekString.split('_')[1]}</h2></div><ul class="staff-list">`;
                
                for (const dayKey of dayKeys) { 
                    // Nếu là ngày quá khứ, lấy từ DB. Nếu ngày tương lai, lấy từ selection
                    const isPast = isCurrentWeek && (dayMap[dayKey] < currentDayIndex);
                    let displayDish = '';
                    
                    if (isPast) {
                        displayDish = existingUserOrder[dayKey] ? parseDish(existingUserOrder[dayKey]) : __('notOrdered');
                    } else {
                        displayDish = parseDish(state.orderSelection[dayKey]);
                    }

                    summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[dayKey]}</div><div class="staff-dish">${displayDish}</div></div></li>`; 
                }
                
                summaryHTML += `</ul><button id="submit-reopen-order-btn" class="btn btn-primary btn-block mt-3"><i class="fas fa-check"></i> ${__('complete')}</button></div>`;
                container.innerHTML = summaryHTML; 
                return;
            }
            
            const shiftToggleHTML = `<div class="form-group"><label class="form-label">${__('shift')}</label><div class="shift-toggle"><input type="radio" id="user-shift-m" name="user-shift" value="morning" ${state.userShiftSelection === 'morning' ? 'checked' : ''}><label for="user-shift-m">${__('morning')}</label><input type="radio" id="user-shift-e" name="user-shift" value="evening" ${state.userShiftSelection === 'evening' ? 'checked' : ''}><label for="user-shift-e">${__('evening')}</label></div></div>`;
            
            let tabsHTML = `<div class="tabs">`;
            for (const dayKey of dayKeys) { 
                const isPast = isCurrentWeek && (dayMap[dayKey] < currentDayIndex);
                // Nếu ngày đã qua, disable tab hoặc style khác
                const styleClass = isPast ? 'opacity: 0.5;' : '';
                tabsHTML += `<button class="tab-btn order-day-tab-btn ${state.currentOrderDay === dayKey ? 'active' : ''}" style="${styleClass}" data-day-key="${dayKey}">${dayNames[dayKey]}</button>`; 
            }
            tabsHTML += `</div>`;
            
            let daysContentHTML = '';
            for (const dayKey of dayKeys) {
                const dishes = menu[dayKey] || [];
                const isPast = isCurrentWeek && (dayMap[dayKey] < currentDayIndex);
                
                daysContentHTML += `<div id="order-day-${dayKey}" class="${state.currentOrderDay === dayKey ? '' : 'hidden'}">`;
                
                if (isPast) {
                    // Hiển thị thông báo ngày đã qua và món đã đặt (nếu có)
                    const oldDish = existingUserOrder[dayKey] ? parseDish(existingUserOrder[dayKey]) : 'Chưa đặt';
                    daysContentHTML += `<div class="text-center p-3" style="color:var(--text-muted);">
                        <i class="fas fa-lock"></i> Ngày này đã qua.<br>
                        Món đã chọn: <strong>${oldDish}</strong>
                    </div>`;
                } else {
                    // Hiển thị danh sách chọn món
                    if (Array.isArray(dishes) && dishes.length > 0) { 
                        daysContentHTML += `<div class="order-dish-list">${dishes.map(dish => `<div class="order-dish-item" data-dish="${dish}" data-day-key="${dayKey}"><div class="order-dish-name">${parseDish(dish)}</div></div>`).join('')}</div>`; 
                    } else { 
                        daysContentHTML += `<p class="text-center text-muted p-3">${__('noDishes')}</p><div class="order-dish-list"><div class="order-dish-item" data-dish="Nghỉ" data-day-key="${dayKey}"><div class="order-dish-name">${__('rest')}</div></div></div>`; 
                    }
                }
                daysContentHTML += `</div>`;
            }
            
            container.innerHTML = `<div class="card"><div style="background: var(--warning); color: white; padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 1rem; text-align: center;"><i class="fas fa-info-circle"></i> Đang chọn: ${dayNames[dayKeys[0]]} ${__('to')} ${dayNames[dayKeys[dayKeys.length - 1]]} (Tuần ${targetWeekString.split('_')[1]})</div><div class="card-header"><h2 class="card-title">Đặt lại món</h2></div>${shiftToggleHTML}${tabsHTML}${daysContentHTML}</div>`;
        }
        
        async function renderMenu() {
            el('main-content').innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title">${__('todayList')}</h2></div><div class="search-bar"><div class="search-wrapper"><i class="fas fa-search search-icon"></i><input type="text" id="search-staff" class="search-input" placeholder="${__('searchStaff')}"></div><button id="menu-filter-btn" class="icon-btn"><i class="fas fa-filter"></i></button></div><div id="staff-list-container"></div></div>`;
            const weekDoc = await getDocument('order_list', getWeekString(new Date()));
            if (weekDoc) {
                updateStaffListView(weekDoc);
                el('search-staff').addEventListener('input', (e) => updateStaffListView(weekDoc, e.target.value));
            } else {
                el('staff-list-container').innerHTML = `<p class="text-center text-muted p-3">${__('noData')}</p>`;
            }
        }

        async function processSkip(receiverName) {
            el('skip-option-modal').classList.add('hidden');
            showLoader();
            try {
                const weekString = getWeekString(new Date());
                const { day, dish } = state.skipTarget;
                const userKey = emailToKey(state.currentUser.email);
                
                const newStatus = `giveup[${receiverName}]`;
                await updateDoc(doc(db, 'order_list', weekString), { [`${userKey}.${day}`]: `${newStatus}: ${dish}` });
                
                showToast(__('skipSuccess')); 
                el('skip-receiver-input').value = '';
                await render();
            } catch (err) { 
                console.error(err); 
                showToast(__('error'), 'error'); 
            } finally { 
                hideLoader(); 
            }
        }
        
        function updateStaffListView(weekDoc, searchTerm = '') {
            const container = el('staff-list-container');
            const hour = new Date().getHours();
            const dayKey = getDayKey();
            
            const staffOrders = Object.entries(weekDoc)
                .filter(([key, val]) => key !== 'menu' && val[dayKey] && val.order !== 'reopen' && val.name && val.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .map(([key, val]) => ({ ...val, key, rawDish: val[dayKey] }));

            el('menu-filter-btn').innerHTML = state.menuFilterMode === 'auto' ? `<i class="fas ${hour < 15 ? 'fa-sun' : 'fa-moon'}"></i>` : `<i class="fas fa-user-group"></i>`;
            
            const createStaffItem = (order) => {
                const { status, receiver } = parseDishValue(order.rawDish);
                const isPlaceholder = status === 'ignore' || status === 'placeholder';
                
                const isPublicGiveup = status === 'giveup' && (receiver === 'Everyone' || receiver === 'Mọi người');
                const isPrivateGiveup = status === 'giveup' && !isPublicGiveup;

                let statusClass = '';
                if (status === 'eaten') statusClass = 'eaten';
                else if (isPublicGiveup) statusClass = 'skipped'; 
                
                let showEatBtn = false;
                if (!isPlaceholder && status !== 'eaten') {
                    if (state.isAdmin) showEatBtn = true;
                    else if (isPublicGiveup) showEatBtn = true;
                }

                const actionBtn = showEatBtn ? `<div class="staff-item-actions"><button class="btn-mark-eaten mark-eaten-btn" data-key="${order.key}" data-day="${dayKey}"><i class="fas fa-check"></i> ${__('eaten')}</button></div>` : '';
                
                let nameHtml = order.name;
                let extraInfo = '';

                if (status === 'giveup') {
                    if (isPrivateGiveup) {
                        nameHtml = `${order.name} <span style="color:var(--warning); font-size: 11px; margin-left: 4px;"><i class="fas fa-long-arrow-alt-right"></i> ${receiver}</span>`;
                    } else {
                        extraInfo = `<div style="font-size:11px;color:var(--warning);margin-top:2px;"> <i class="fas fa-users"></i> ${__('everyone')}</div>`;
                    }
                }

                return `<li class="staff-item ${statusClass}"><div class="staff-details"><div class="staff-name">${nameHtml}</div><div class="staff-dish">${parseDish(order.rawDish)}</div>${extraInfo}</div>${actionBtn}</li>`;
            };
            
            const createDepartmentHTML = (list) => {
                const byDepartment = {};
                list.forEach(order => { const depart = order.depart || __('unknown'); if (!byDepartment[depart]) byDepartment[depart] = []; byDepartment[depart].push(order); });
                const sortedDepartments = Object.keys(byDepartment).sort();
                return sortedDepartments.map(depart => {
                    const sorted = byDepartment[depart].sort((a, b) => {
                         const { status: sA } = parseDishValue(a.rawDish); const { status: sB } = parseDishValue(b.rawDish);
                         return ({not:0,eaten:1}[sA]||0) - ({not:0,eaten:1}[sB]||0) || a.name.localeCompare(b.name);
                    });
                    return `<div class="department-group"><div class="department-header">${depart}</div><ul class="staff-list">${sorted.map(order => createStaffItem(order)).join('')}</ul></div>`;
                }).join('');
            };
            
            const createSkippedSection = (list) => {
                if (list.length === 0) return '';
                const sorted = list.sort((a, b) => a.name.localeCompare(b.name));
                return `<div class="skipped-section"><div class="skipped-section-header"><i class="fas fa-hand-holding-heart"></i><span>${__('skippedList')} (${list.length})</span></div><ul class="staff-list">${sorted.map(order => createStaffItem(order)).join('')}</ul></div>`;
            };
            
            const sang = staffOrders.filter(o => o.shift === 'morning' || o.shift === 'M');
            const chieu = staffOrders.filter(o => o.shift === 'evening' || o.shift === 'E');
            
            const createShiftHTML = (list) => {
                const skipped = list.filter(o => {
                    const { status, receiver } = parseDishValue(o.rawDish);
                    return status === 'giveup' && (receiver === 'Everyone' || receiver === 'Mọi người');
                });
                const others = list.filter(o => {
                    const { status, receiver } = parseDishValue(o.rawDish);
                    const isPublicGiveup = status === 'giveup' && (receiver === 'Everyone' || receiver === 'Mọi người');
                    return !isPublicGiveup;
                });
                return createSkippedSection(skipped) + createDepartmentHTML(others);
            };
            
            let html = '';
            if ((state.menuFilterMode === 'auto' && hour < 15) || state.menuFilterMode === 'all') {
                if (sang.length) html += `<h3 style="color:var(--primary);padding:1rem 0 .5rem;font-size:18px;border-bottom:2px solid var(--primary);margin-bottom:1rem;">${__('morning')}</h3>` + createShiftHTML(sang);
            }
            if ((state.menuFilterMode === 'auto' && hour >= 15) || state.menuFilterMode === 'all') {
                if (chieu.length) html += `<h3 style="color:var(--primary);padding:1rem 0 .5rem;font-size:18px;border-bottom:2px solid var(--primary);margin-bottom:1rem;margin-top:${sang.length ? '2rem' : '0'};">${__('evening')}</h3>` + createShiftHTML(chieu);
            }
            container.innerHTML = html || `<p class="text-center text-muted p-3">${__('notFound')}</p>`;
        }
        
        async function renderProfile() {
            const { currentUser: user, staffProfile: profile } = state;
            const currentTheme = profile.theme || 'dark';
            
            document.documentElement.setAttribute('data-theme', currentTheme);

            const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.name)}&background=random&color=fff&size=128`;

            el('main-content').innerHTML = `
            <div class="card">
                <div class="profile-section">
                    <img src="${user.photoURL}" alt="avatar" class="profile-avatar">
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-depart">${profile.depart || __('notUpdated')}</div>
                    
                    <div class="toggle-group-container" style="margin-top: 2rem;">
                        <div>
                            <div class="toggle-group">
                                <div class="toggle-option lang-toggle-btn ${profile.lan === 'vi' ? 'active' : ''}" data-lang="vi">Tiếng Việt</div>
                                <div class="toggle-option lang-toggle-btn ${profile.lan === 'en' ? 'active' : ''}" data-lang="en">English</div>
                            </div>
                        </div>
        
                        <div>
                            <div class="toggle-group">
                                <div class="toggle-option theme-toggle-btn ${currentTheme === 'dark' ? 'active' : ''}" data-theme="dark"><i class="fas fa-moon"></i> Dark</div>
                                <div class="toggle-option theme-toggle-btn ${currentTheme === 'light' ? 'active' : ''}" data-theme="light"><i class="fas fa-sun"></i> Light</div>
                            </div>
                        </div>
                    </div>
        
                    <div style="margin-top: 3rem; display: flex; justify-content: center; gap: 12px;">
                        <a href="mailto:${SUPPORT_EMAIL}" class="btn btn-secondary" style="text-decoration: none; min-width: 110px;">
                            <i class="fas fa-headset"></i> ${__('support')}
                        </a>
                        
                        <button id="logout-menu-item" class="btn btn-secondary" style="min-width: 110px;">
                            <i class="fas fa-sign-out-alt"></i> ${__('logout')}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        async function renderAdmin() {
            el('main-content').innerHTML = `<div class="card">
                <div class="tabs">
                    <button class="tab-btn ${state.adminSubTab === 'support' ? 'active' : ''}" data-subtab="support"><i class="fas fa-headset"></i><span class="tab-label">${__('support')}</span></button>
                    <button class="tab-btn ${state.adminSubTab === 'stats' ? 'active' : ''}" data-subtab="stats"><i class="fas fa-chart-pie"></i><span class="tab-label">${__('stats')}</span></button>
                    <button class="tab-btn ${state.adminSubTab === 'menu' ? 'active' : ''}" data-subtab="menu"><i class="fas fa-utensils"></i><span class="tab-label">${__('menu')}</span></button>
                    <button class="tab-btn ${state.adminSubTab === 'personnel' ? 'active' : ''}" data-subtab="personnel"><i class="fas fa-user-group"></i><span class="tab-label">${__('personnel')}</span></button>
                </div>
                <div id="admin-content"></div>
            </div>`;
            await renderAdminSubTab();
        }


        async function getDepartmentsList() {
            let deptDoc = await getDocument("admin_list", "departments");
            if (deptDoc && deptDoc.list) return deptDoc.list.sort();
            
            const allStaff = await getDocument("staff_list", "staffs");
            if (allStaff) {
                const tempSet = new Set();
                Object.values(allStaff).forEach(p => {
                    if (p.depart && p.depart.trim() && p.depart !== 'Unknown') tempSet.add(p.depart.trim());
                });
                const list = Array.from(tempSet).sort();
                await setDoc(doc(db, "admin_list", "departments"), { list });
                return list;
            }
            return [];
        }
        async function renderAdminDepartments() {
            const departments = await getDepartmentsList();
            const allStaff = await getDocument("staff_list", "staffs");
            const counts = {};
            departments.forEach(d => counts[d] = 0);
            if (allStaff) {
                Object.values(allStaff).forEach(p => {
                    if (p.depart && departments.includes(p.depart)) {
                        counts[p.depart] = (counts[p.depart] || 0) + 1;
                    }
                });
            }
        
            el('admin-content').innerHTML = `
            <div class="mt-3">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3 style="color:var(--primary);font-size:18px;">Quản lý Phòng ban (${departments.length})</h3>
                    <button id="add-department-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Thêm phòng ban</button>
                </div>
        
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Tên phòng ban</th>
                                <th class="text-center">Số lượng NS</th>
                                <th style="width:100px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${departments.length > 0 ? departments.map(d => `
                            <tr>
                                <td><span style="font-weight:600;">${d}</span></td>
                                <td class="text-center">${counts[d] || 0}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="icon-btn edit-department-btn" data-name="${d}"><i class="fas fa-edit"></i></button>
                                        <button class="icon-btn delete-department-btn" data-name="${d}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>`).join('') : `<tr><td colspan="3" class="text-center text-muted p-3">Chưa có phòng ban nào</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }
        async function renderAdminSubTab() {
            switch (state.adminSubTab) {
                case 'stats': await renderAdminStats(); break;
                case 'support': await renderAdminSupport(); break;
                case 'menu': await renderAdminMenu(); break;
                case 'personnel': await renderAdminPersonnel(); break; 
            }
        }
        function getStatsDateDisplayText(date, mode) {
            const d = new Date(date);
            const day = d.getDate();
            const month = d.getMonth() + 1;
            const year = d.getFullYear();
            
            if (mode === 'day') {
                const dayNames = [__('sun'), __('mon'), __('tue'), __('wed'), __('thu'), __('fri'), __('sat')];
                return `${dayNames[d.getDay()]}, ${day < 10 ? '0'+day : day}/${month < 10 ? '0'+month : month}/${year}`;
            } 
            else if (mode === 'week') {
                const weekStr = getWeekString(d);
                const start = new Date(d);
                start.setDate(start.getDate() - (start.getDay() || 7) + 1);
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                
                return `Tuần ${weekStr.split('_')[1]} (${start.getDate()}/${start.getMonth()+1} - ${end.getDate()}/${end.getMonth()+1})`;
            } 
            else {
                return `Tháng ${month}/${year}`;
            }
        }
        async function renderAdminStats() {
            const dateStr = state.statsViewDate.toISOString().split('T')[0];
            const displayText = getStatsDateDisplayText(state.statsViewDate, state.statsViewMode);
            
            const modeIcons = { day: 'fa-calendar-day', week: 'fa-calendar-week', month: 'fa-calendar' };
            const modeLabels = { day: __('day'), week: __('week'), month: __('month') };

            el('admin-content').innerHTML = `
            <div class="mt-3">
                <div class="stats-header">
                    <div style="position: relative;">
                        <button id="stats-options-btn" class="options-btn">
                            <div style="display:flex; align-items:center;">
                                <i class="fas ${modeIcons[state.statsViewMode]}"></i>
                                <span class="btn-label-text">${modeLabels[state.statsViewMode]}</span>
                            </div>
                            <i class="fas fa-chevron-down btn-label-text" style="font-size: 10px; opacity: 0.6;"></i>
                        </button>
                        
                        <div id="stats-dropdown" class="stats-dropdown">
                            <div class="dropdown-item ${state.statsViewMode === 'day' ? 'active' : ''}" data-action="set-mode" data-mode="day">
                                <i class="fas fa-calendar-day" style="width:20px"></i> ${__('day')}
                            </div>
                            <div class="dropdown-item ${state.statsViewMode === 'week' ? 'active' : ''}" data-action="set-mode" data-mode="week">
                                <i class="fas fa-calendar-week" style="width:20px"></i> ${__('week')}
                            </div>
                            <div class="dropdown-item ${state.statsViewMode === 'month' ? 'active' : ''}" data-action="set-mode" data-mode="month">
                                <i class="fas fa-calendar" style="width:20px"></i> ${__('month')}
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="stats-today-btn">
                                <i class="fas fa-undo" style="width:20px"></i> Hôm nay
                            </div>
                        </div>
                    </div>

                    <div class="date-navigator">
                        <button id="prev-date-btn" class="nav-arrow-btn"><i class="fas fa-chevron-left"></i></button>
                        
                        <div class="date-display-wrapper" onclick="document.getElementById('stats-date-picker').showPicker()">
                            <span class="date-display-text">${displayText}</span>
                            <input type="date" id="stats-date-picker" class="hidden-date-input" value="${dateStr}">
                        </div>
                        
                        <button id="next-date-btn" class="nav-arrow-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div id="stats-content" class="mt-2"></div>
                <button id="export-stats-btn" class="btn btn-primary btn-block mt-3"><i class="fas fa-file-excel"></i> ${__('downloadXLSX')}</button>
            </div>`;
            
            await renderStatsContent();
        }
        async function renderAdminSupport(searchTerm = '') {
            const today = new Date();
            const currentDayIdx = today.getDay();
            const currentHour = today.getHours();
        
            const thisWeekStr = getWeekString(today);
            const nextWeekStr = getWeekString(new Date(today.getTime() + 7 * 86400000));
        
            const isNextWeekOpen = (currentDayIdx === 4 && currentHour >= 15) || currentDayIdx === 5 || currentDayIdx === 6 || currentDayIdx === 0;
        
            const [allStaff, thisWeekDoc, nextWeekDoc] = await Promise.all([
                getDocument("staff_list", "staffs"), 
                getDocument('order_list', thisWeekStr),
                getDocument('order_list', nextWeekStr)
            ]);
            
            const menuThisWeek = thisWeekDoc ? thisWeekDoc.menu : {};
            const menuNextWeek = nextWeekDoc ? nextWeekDoc.menu : {};
            
            let staffList = allStaff ? Object.entries(allStaff)
                .filter(([key]) => !key.startsWith('guest_'))
                .map(([key, profile]) => {
                    const orderThis = thisWeekDoc && thisWeekDoc[key] ? thisWeekDoc[key] : null;
                    let statusThis = 'missing';
                    if (orderThis && orderThis.order === 'ordered') {
                        const shift = (orderThis.shift || 'morning').toLowerCase();
                        statusThis = (shift.includes('evening') || shift === 'e') ? 'evening' : 'morning';
                    } else if (orderThis && orderThis.order === 'reopen') {
                        statusThis = 'missing';
                    }
        
                    const orderNext = nextWeekDoc && nextWeekDoc[key] ? nextWeekDoc[key] : null;
                    let statusNext = 'missing'; 
                    let showNext = isNextWeekOpen; 
        
                    if (orderNext && orderNext.order === 'ordered') {
                        const shift = (orderNext.shift || 'morning').toLowerCase();
                        statusNext = (shift.includes('evening') || shift === 'e') ? 'evening' : 'morning';
                        showNext = true; 
                    } else if (orderNext && orderNext.order === 'reopen') {
                        showNext = true;
                    }
        
                    return { key, profile, orderThis, statusThis, orderNext, statusNext, showNext };
                })
                .sort((a, b) => a.profile.name.localeCompare(b.profile.name)) : [];
        
            if (searchTerm) {
                const lower = searchTerm.toLowerCase();
                staffList = staffList.filter(i => i.profile.name.toLowerCase().includes(lower) || i.profile.email.toLowerCase().includes(lower));
            }
        
            let html = `<div class="mt-3">
            <div class="search-bar mb-2">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-support" class="search-input" placeholder="${__('searchStaff')}" value="${searchTerm}">
                </div>
                <button id="add-guest-order-btn" class="icon-btn" title="${__('addGuest')}"><i class="fas fa-user-plus"></i></button>
            </div>`;
        
            if (staffList.length > 0) {
                html += `<div class="table-wrapper"><table>
                    <thead>
                        <tr>
                            <th style="width: 50px; text-align: center;">Tuần này</th>
                            <th style="width: 50px; text-align: center;">Tuần sau</th>
                            <th>${__('name')}</th>
                            <th class="hide-mobile">${__('department')}</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
                const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
                const dayNames = { mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') };
        
                const renderIcon = (status, key, weekType) => {
                    let iconClass = 'status-missing';
                    let iconContent = '<i class="fas fa-times"></i>';
                    if (status === 'morning') { iconClass = 'status-sun'; iconContent = '<i class="fas fa-sun"></i>'; }
                    else if (status === 'evening') { iconClass = 'status-moon'; iconContent = '<i class="fas fa-moon"></i>'; }
                    
                    return `<div class="status-icon-btn ${iconClass}" data-key="${key}" data-weektype="${weekType}">${iconContent}</div>`;
                };
        
                const renderDetailBlock = (key, weekType, orderData, menuData, isPastWeek) => {
                    const currentShift = orderData ? orderData.shift : 'morning';
                    
                    let content = `<div id="detail-${weekType}-${key}" class="week-detail-container hidden" style="border:none; box-shadow:none; margin:0; border-radius:0;">`;
                    
                    content += `<div class="detail-inner-wrapper">`;
                    content += `<div class="week-detail-title"><i class="fas fa-calendar-alt"></i> Chi tiết ${weekType === 'this' ? 'Tuần này' : 'Tuần sau'}</div>`;
                    
                    content += `<div class="form-group" style="max-width: 300px;"><label class="form-label" style="font-size:11px;color:var(--primary);">Ca làm việc</label><div class="shift-toggle">
                        <input type="radio" id="shift-m-${weekType}-${key}" name="shift-${weekType}-${key}" value="morning" ${currentShift !== 'evening' ? 'checked' : ''}><label for="shift-m-${weekType}-${key}">${__('morning')}</label>
                        <input type="radio" id="shift-e-${weekType}-${key}" name="shift-${weekType}-${key}" value="evening" ${currentShift === 'evening' ? 'checked' : ''}><label for="shift-e-${weekType}-${key}">${__('evening')}</label>
                    </div></div>`;
        
                    content += `<div style="margin-bottom: 1rem;">`;
                    dayKeys.forEach((dKey, idx) => {
                        const isPast = (weekType === 'this') && ((idx + 1) < currentDayIdx && currentDayIdx !== 0 && currentDayIdx !== 6);
                        const userDishRaw = orderData ? orderData[dKey] : '';
                        const { dish: currentDish } = parseDishValue(userDishRaw);
                        const dishes = menuData[dKey] || [];
        
                        content += `<div class="day-block" style="border-bottom:1px dashed var(--border); padding-bottom:8px; margin-bottom:8px;">
                            <span class="day-label ${isPast ? 'past' : ''}" style="display:flex; justify-content:space-between;"><span>${dayNames[dKey]}</span>${isPast ? '<span style="font-size:10px;">(Đã qua)</span>' : ''}</span>
                            <div class="mini-dish-list">`;
                        
                        if (dishes.length > 0) {
                            dishes.forEach(dish => {
                                const isSelected = dish === currentDish;
                                const disabledClass = isPast ? 'disabled' : '';
                                content += `<div class="mini-dish-item ${isSelected ? 'selected' : ''} ${disabledClass}" data-dish="${dish}" data-day="${dKey}" ${isPast ? '' : 'onclick="selectAdminDish(this)"'}>${parseDish(dish)}</div>`;
                            });
                        } else { content += `<span class="text-muted" style="font-size:12px;">${__('rest')}</span>`; }
                        content += `</div></div>`;
                    });
                    content += `</div>`;
        
                    const weekStringValue = weekType === 'this' ? thisWeekStr : nextWeekStr;
                    const userName = allStaff[key] ? allStaff[key].name : '';
                    
                    content += `<div class="admin-action-buttons">
                        <div class="btn-group-row">
                            <button class="btn btn-delete-order" data-key="${key}" data-weekstr="${weekStringValue}" data-weektype="${weekType}" style="flex: 1;"><i class="fas fa-trash"></i> Hủy đặt</button>
                            <button class="btn btn-secondary reopen-order-btn" data-key="${key}" data-name="${userName}" data-weekstr="${weekStringValue}" style="flex: 1; border: 1px solid var(--warning); color: var(--warning);"><i class="fas fa-redo"></i> Reopen</button>
                        </div>
                        <button class="btn btn-primary admin-save-user-btn" data-key="${key}" data-weekstr="${weekStringValue}" data-weektype="${weekType}" style="width: 100%;"><i class="fas fa-save"></i> Lưu ${weekType === 'this' ? 'Tuần này' : 'Tuần sau'}</button>
                    </div>`;
                    
                    content += `</div></div>`; 
                    return content;
                };
        
                staffList.forEach(item => {
                    const { key, profile, orderThis, statusThis, orderNext, statusNext, showNext } = item;
        
                    html += `<tr class="support-row">
                        <td style="text-align: center;">${renderIcon(statusThis, key, 'this')}</td>
                        <td style="text-align: center;">${showNext ? renderIcon(statusNext, key, 'next') : '<span class="text-muted">-</span>'}</td>
                        <td style="font-weight: 500;">${profile.name}</td>
                        <td class="hide-mobile">${profile.depart || '-'}</td>
                    </tr>`;
                    html += `<tr id="row-detail-${key}" class="detail-row hidden"><td colspan="4"><div class="detail-content">
                        ${renderDetailBlock(key, 'this', orderThis, menuThisWeek, false)}
                        ${showNext ? renderDetailBlock(key, 'next', orderNext, menuNextWeek, false) : ''}
                    </div></td></tr>`;
                });
        
                html += `</tbody></table></div>`;
            } else { html += `<p class="text-center text-muted p-3">${__('notFound')}</p>`; }
        
            html += `</div>`;
            
            el('admin-content').innerHTML = html;
            const searchInput = el('search-support');
            if(searchInput) { 
                searchInput.focus(); 
                const val = searchInput.value; 
                searchInput.value = ''; 
                searchInput.value = val; 
                searchInput.addEventListener('input', (e) => renderAdminSupport(e.target.value)); 
            }
        }
        
        window.selectAdminDish = (elem) => {
            const parent = elem.parentElement;
            parent.querySelectorAll('.mini-dish-item').forEach(el => el.classList.remove('selected'));
            elem.classList.add('selected');
        };
        async function renderStatsContent() {
            const statsContent = el('stats-content');
            const headers = { ordered: `<i class="fas fa-list-ul" title="${__('ordered')}"></i>`, eaten: `<i class="fas fa-check" title="${__('eaten')}"></i>`, notEaten: `<i class="fas fa-xmark" title="${__('notEaten')}"></i>` };
            
            if (state.statsViewMode === 'day') {
                const dayKey = getDayKey(state.statsViewDate);
                const weekStr = getWeekString(state.statsViewDate);
                
                const weekDoc = await getDocument('order_list', weekStr);
                
                if (!weekDoc) { 
                    statsContent.innerHTML = `<p class="text-center text-muted p-3">${__('noData')}</p>`; 
                    return; 
                }
                
                const stats = { morning: {}, evening: {} };
                let hasData = false;
                
                Object.entries(weekDoc).forEach(([key, val]) => {
                    if (key === 'menu' || typeof val !== 'object' || !val) return;
                    if (val.order === 'reopen' || !val[dayKey]) return;
                    
                    const { status } = parseDishValue(val[dayKey]);
                    
                    if (status === 'ignore' || status === 'placeholder') return;

                    const dish = parseDish(val[dayKey]);
                    if (!dish) return;

                    const rawShift = String(val.shift || 'morning').toLowerCase().trim();
                    const shiftKey = (rawShift.includes('e') || rawShift === 'evening') ? 'evening' : 'morning';
                    
                    if (!stats[shiftKey][dish]) {
                        stats[shiftKey][dish] = { ordered: 0, eaten: 0, notEaten: 0 };
                    }
                    
                    hasData = true;
                    
                    stats[shiftKey][dish].ordered++;
                    
                    if (status === 'eaten') {
                        stats[shiftKey][dish].eaten++; 
                    } else {
                        stats[shiftKey][dish].notEaten++;
                    }
                });

                if (!hasData) {
                    statsContent.innerHTML = `<p class="text-center text-muted p-3">${__('noData')}</p>`;
                    return;
                }

                const createTable = (data, name) => {
                    if (Object.keys(data).length === 0) return '';
                    const totals = Object.values(data).reduce((acc, curr) => ({ordered: acc.ordered + curr.ordered, eaten: acc.eaten + curr.eaten, notEaten: acc.notEaten + curr.notEaten}), {ordered: 0, eaten: 0, notEaten: 0});
                    return `<div class="table-wrapper"><table><thead><tr><th>${name}</th><th>${headers.ordered}</th><th>${headers.eaten}</th><th>${headers.notEaten}</th></tr></thead><tbody>${Object.entries(data).map(([dish, d]) => `<tr><td>${dish}</td><td>${d.ordered}</td><td>${d.eaten}</td><td>${d.notEaten}</td></tr>`).join('')}<tr style="font-weight:600;background:rgba(102,126,234,0.1)"><td>${__('total')}</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr></tbody></table></div>`;
                };
                
                statsContent.innerHTML = createTable(stats.morning, __('morning')) + createTable(stats.evening, __('evening'));

            } else {
                const isMonth = state.statsViewMode === 'month', date = new Date(state.statsViewDate);
                const first = isMonth ? new Date(date.getFullYear(), date.getMonth(), 1) : new Date(date.setDate(date.getDate() - (date.getDay() || 7) + 1));
                const last = isMonth ? new Date(date.getFullYear(), date.getMonth() + 1, 0) : new Date(new Date(first).setDate(first.getDate() + 4));
                const departStats = {};
                
                for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() === 0 || d.getDay() === 6) continue;
                    const dayKey = getDayKey(d);
                    const weekDoc = await getDocument('order_list', getWeekString(d));
                    
                    if (weekDoc) Object.entries(weekDoc).forEach(([key, val]) => {
                        if (key === 'menu' || typeof val !== 'object' || val.order === 'reopen' || !val[dayKey]) return;
                        
                        const { status } = parseDishValue(val[dayKey]);
                        if (status === 'placeholder') return;
                        
                        const depart = val.depart || __('unknown');
                        if (!departStats[depart]) departStats[depart] = { ordered: 0, eaten: 0, notEaten: 0 };
                        
                        departStats[depart].ordered++;
                        if (status === 'eaten') departStats[depart].eaten++; 
                        else departStats[depart].notEaten++;
                    });
                }
                if (Object.keys(departStats).length === 0) { statsContent.innerHTML = `<p class="text-center text-muted p-3">${__('noData')}</p>`; return; }
                const totals = Object.values(departStats).reduce((acc, curr) => ({ordered: acc.ordered + curr.ordered, eaten: acc.eaten + curr.eaten, notEaten: acc.notEaten + curr.notEaten}), {ordered: 0, eaten: 0, notEaten: 0});
                statsContent.innerHTML = `<div class="table-wrapper"><table><thead><tr><th>${__('department')}</th><th>${headers.ordered}</th><th>${headers.eaten}</th><th>${headers.notEaten}</th></tr></thead><tbody>${Object.entries(departStats).map(([dep, d]) => `<tr><td>${dep}</td><td>${d.ordered}</td><td>${d.eaten}</td><td>${d.notEaten}</td></tr>`).join('')}<tr style="font-weight:600;background:rgba(102,126,234,0.1)"><td>${__('total')}</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr></tbody></table></div>`;
            }
        }        
        async function renderAdminMenu() {
            const today = new Date();
            const thisWeek = getWeekString(today);
            const nextWeek = getWeekString(new Date(today.getTime() + 7 * 86400000));
            const [thisWeekDoc, nextWeekDoc] = await Promise.all([getDocument('order_list', thisWeek), getDocument('order_list', nextWeek)]);
            const thisWeekMenu = thisWeekDoc ? thisWeekDoc.menu : {};
            const nextWeekMenu = nextWeekDoc ? nextWeekDoc.menu : {};

            const hasNextWeekData = nextWeekMenu && Object.values(nextWeekMenu).some(d => d && d.length > 0);
        
            const renderReadOnlyMenuSection = (menuData, title) => {
                let html = ``;
                for (const [dayKey, dayName] of Object.entries({ mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') })) {
                    const dishes = menuData[dayKey] || [];
                    html += `<div class="form-group"><label class="form-label">${dayName}</label><ul class="staff-list">`;
                    if (dishes.length > 0) dishes.forEach(dish => html += `<li class="staff-item"><div class="staff-details"><div class="staff-dish">${parseDish(dish)}</div></div></li>`);
                    else html += `<li class="staff-item"><div class="staff-details"><div class="staff-dish text-muted">${__('noDishYet')}</div></div></li>`;
                    html += `</ul></div>`;
                }
                return html;
            };
        
            const renderEditableMenuSection = (weekKey, menuData) => {
                let html = `<div style="margin-bottom:1.5rem;">`;
                
                html += `<button onclick="document.getElementById('menu-file-input').click()" class="btn btn-secondary" style="width:100%; justify-content:center; padding:12px; font-size:14px; border: 1px dashed var(--border);">
                            <i class="fas fa-file-excel" style="color:#16a34a; font-size:18px; margin-right:8px;"></i> 
                            <span style="font-weight:600; color: var(--text-muted);">Tải lên Excel (Menu tuần sau)</span>
                         </button>
                         <input type="file" id="menu-file-input" class="hidden" accept=".xlsx, .xls, .csv">`;
                html += `</div>`;

                for (const [dayKey, dayName] of Object.entries({ mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') })) {
                    const dishes = menuData[dayKey] || [];
                    html += `<div class="form-group"><label class="form-label">${dayName}</label>`;
                    if (dishes.length > 0) { html += `<ul class="staff-list">`; dishes.forEach(dish => html += `<li class="staff-item"><div class="staff-details"><div class="staff-dish">${parseDish(dish)}</div></div></li>`); html += `</ul>`; }
                    html += `<div id="menu-dishes-${weekKey}-${dayKey}" style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.5rem;"><div style="display:flex;gap:0.5rem;align-items:center;"><textarea class="form-textarea menu-dish-textarea" data-week="${weekKey}" data-day="${dayKey}" data-index="${dishes.length}" placeholder="${__('oneDishPerLine')}" style="flex:1;min-height:40px;padding-bottom:10px;overflow:hidden;"></textarea><button class="icon-btn remove-menu-dish-btn hidden" data-week="${weekKey}" data-day="${dayKey}" data-index="${dishes.length}"><i class="fas fa-times"></i></button></div></div></div>`;
                }
                return html;
            };
            
            let contentHTML = `<div class="mt-3">`;

            contentHTML += `
            <div style="display:flex; gap:6px; margin-bottom:1.5rem; background:var(--card-bg); padding:4px; border-radius:8px; border:1px solid var(--border);">
                <button class="btn" style="flex:1; border:none; box-shadow:none; transition:all 0.2s; background: ${state.adminMenuTab === 'this' ? 'var(--primary)' : 'transparent'}; color: ${state.adminMenuTab === 'this' ? 'white' : 'var(--text-muted)'}; font-weight:600;" onclick="switchAdminMenuTab('this')">
                    <i class="fas fa-calendar-week"></i> Tuần này (${thisWeek.split('_')[1]})
                </button>
                <button class="btn" style="flex:1; border:none; box-shadow:none; transition:all 0.2s; background: ${state.adminMenuTab === 'next' ? 'var(--primary)' : 'transparent'}; color: ${state.adminMenuTab === 'next' ? 'white' : 'var(--text-muted)'}; font-weight:600;" onclick="switchAdminMenuTab('next')">
                    <i class="fas fa-calendar-plus"></i> Tuần sau (${nextWeek.split('_')[1]})
                </button>
            </div>`;
            
            if (state.adminMenuTab === 'this') {
                contentHTML += renderReadOnlyMenuSection(thisWeekMenu);
            } else {
                if (hasNextWeekData && !state.isEditingMenu) {
                    contentHTML += renderReadOnlyMenuSection(nextWeekMenu);
                    contentHTML += `
                    <div class="mt-3 text-center">
                        <p class="text-muted mb-3"><i class="fas fa-check-circle" style="color:var(--success)"></i> ${__('menuSavedState')}</p>
                        <button id="edit-menu-btn" class="btn btn-secondary btn-block"><i class="fas fa-edit"></i> Chỉnh sửa menu</button>
                    </div>`;
                } else {
                    contentHTML += renderEditableMenuSection('nextWeek', nextWeekMenu);
                    contentHTML += `<button id="save-menu-nextWeek" class="btn btn-primary btn-block" style="margin-top:1rem;" data-week="${nextWeek}"><i class="fas fa-save"></i> ${__('save')} ${__('menuNextWeek')}</button>`;
                    
                    if (state.isEditingMenu) {
                         contentHTML += `<button id="cancel-edit-menu-btn" class="btn btn-secondary btn-block mt-2">${__('cancel')}</button>`;
                    }
                }
            }

            contentHTML += `</div>`;
            el('admin-content').innerHTML = contentHTML;
            document.querySelectorAll('.menu-dish-textarea').forEach(autoResizeTextarea);
        }

        async function renderAdminPersonnel(searchTerm = '') {
            let html = `<div class="mt-3">`;
            
            html += `
            <div style="display:flex; gap:6px; margin-bottom:1.5rem; background:var(--card-bg); padding:4px; border-radius:8px; border:1px solid var(--border);">
                <button class="btn" style="flex:1; border:none; box-shadow:none; transition:all 0.2s; background: ${state.personnelViewMode === 'staff' ? 'var(--primary)' : 'transparent'}; color: ${state.personnelViewMode === 'staff' ? 'white' : 'var(--text-muted)'}; font-weight:600;" onclick="switchPersonnelMode('staff')">
                    <i class="fas fa-users"></i> Nhân viên
                </button>
                <button class="btn" style="flex:1; border:none; box-shadow:none; transition:all 0.2s; background: ${state.personnelViewMode === 'dept' ? 'var(--primary)' : 'transparent'}; color: ${state.personnelViewMode === 'dept' ? 'white' : 'var(--text-muted)'}; font-weight:600;" onclick="switchPersonnelMode('dept')">
                    <i class="fas fa-building"></i> Phòng ban
                </button>
            </div>`;
        
            if (state.personnelViewMode === 'staff') {
                const allStaff = await getDocument("staff_list", "staffs");
                let sorted = allStaff ? Object.entries(allStaff).filter(([key]) => !key.startsWith('guest_')).sort((a, b) => a[1].name.localeCompare(b[1].name)) : [];
                
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    sorted = sorted.filter(([_, p]) => p.name.toLowerCase().includes(lowerTerm) || p.email.toLowerCase().includes(lowerTerm));
                }
        
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap: 8px;">
                    <div class="search-wrapper" style="flex:1;">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-personnel" class="search-input" placeholder="${__('searchStaff')}" value="${searchTerm}">
                    </div>
                    <button id="add-personnel-btn" class="icon-btn" title="Thêm thủ công"><i class="fas fa-plus"></i></button>
                </div>`;
                
                html += `
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>${__('personnel')}</th><th class="hide-mobile">${__('email')}</th><th class="hide-mobile">${__('department')}</th><th> </th></tr></thead>
                        <tbody>
                            ${sorted.length > 0 ? sorted.map(([key, p]) => `<tr><td>${p.name}</td><td class="hide-mobile">${p.email}</td><td class="hide-mobile">${p.depart || '-'}</td><td style="white-space: nowrap;"><div class="action-buttons"><button class="icon-btn edit-personnel-btn" data-key="${key}"><i class="fas fa-edit"></i></button><button class="icon-btn delete-personnel-btn" data-key="${key}" data-name="${p.name}"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : `<tr><td colspan="4" class="text-center text-muted p-3">${__('noData')}</td></tr>`}
                        </tbody>
                    </table>
                </div>`;

                html += `
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px;">
                     <button onclick="document.getElementById('personnel-import-input').click()" class="btn btn-secondary btn-block" style="border: 1px dashed var(--warning); color: var(--warning);">
                        <i class="fas fa-file-upload"></i> Import Excel (Ghi đè)
                    </button>
                    <input type="file" id="personnel-import-input" class="hidden" accept=".xlsx, .xls, .csv">

                    <button id="export-personnel-btn" class="btn btn-block" style="background-color: var(--success); color: white; border: none;">
                        <i class="fas fa-file-export"></i> Xuất Excel (Backup)
                    </button>
                </div>`;

            } else {
                const departments = await getDepartmentsList();
                
                const allStaff = await getDocument("staff_list", "staffs");
                const counts = {};
                departments.forEach(d => counts[d] = 0);
                if (allStaff) {
                    Object.values(allStaff).forEach(p => {
                        if (p.depart && departments.includes(p.depart)) counts[p.depart] = (counts[p.depart] || 0) + 1;
                    });
                }
        
                html += `     
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Tên phòng ban</th><th class="text-center">Nhân sự</th><th style="width:100px;"> </th></tr></thead>
                        <tbody>
                            ${departments.length > 0 ? departments.map(d => `
                            <tr>
                                <td><span style="font-weight:600;">${d}</span></td>
                                <td class="text-center">${counts[d] || 0}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="icon-btn edit-department-btn" data-name="${d}"><i class="fas fa-edit"></i></button>
                                        <button class="icon-btn delete-department-btn" data-name="${d}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>`).join('') : `<tr><td colspan="3" class="text-center text-muted p-3">Chưa có phòng ban</td></tr>`}
                        </tbody>
                    </table>
                </div>`;
                html += `<button id="add-department-btn" class="btn btn-primary btn-block mt-2"><i class="fas fa-plus"></i> Thêm phòng ban mới</button>`;
            }
        
            html += `</div>`;
            el('admin-content').innerHTML = html;
        
            const searchInput = el('search-personnel');
            if (searchInput) {
                searchInput.focus();
                const val = searchInput.value; searchInput.value = ''; searchInput.value = val;
                searchInput.addEventListener('input', (e) => renderAdminPersonnel(e.target.value));
            }
        }
        
        window.switchPersonnelMode = async (mode) => {
            state.personnelViewMode = mode;
            await renderAdminPersonnel();
        };
        window.switchAdminMenuTab = async (tab) => {
            state.adminMenuTab = tab;
            await renderAdminMenu();
        };
        async function syncUserProfile() {
            const userEmailKey = emailToKey(state.currentUser.email);
            const staffData = await getDocument("staff_list", "staffs");
            if (!staffData || !staffData[userEmailKey]) { await signOut(auth); throw new Error("Tài khoản không có trong danh sách."); }
            state.staffProfile = staffData[userEmailKey];

            const userTheme = state.staffProfile.theme || 'dark';
            document.documentElement.setAttribute('data-theme', userTheme);

            try { const adminData = await getDocument("admin_list", "admins"); state.isAdmin = adminData && adminData[userEmailKey] === true; } catch { state.isAdmin = false; }
        }

        function updateUIForUser(user) {
            const tabBar = el('tab-bar');
            if (user && state.staffProfile) {
                let html = `<button class="nav-item active" data-tab="today"><i class="fas fa-home"></i></button><button class="nav-item" data-tab="menu"><i class="fas fa-list"></i></button>`;
                if (state.isAdmin) html += `<button class="nav-item" data-tab="admin"><i class="fas fa-crown"></i></button>`;
                html += `<button class="nav-item" data-tab="profile"><i class="fas fa-user-circle"></i></button>`;
                tabBar.innerHTML = html; tabBar.classList.remove('hidden');
            } else {
                tabBar.classList.add('hidden');
                el('main-content').innerHTML = `<div class="card hero-card"><div class="hero-content"><div class="hero-title">${__('welcome')}</div><div class="hero-subtitle mb-3">${__('pleaseLogin')}</div><button id="login-btn" class="btn btn-primary"><i class="fab fa-google"></i> ${__('login')}</button></div></div>`;
            }
        }
        
        async function renderGuestOrderDays(weekType) {
            const container = el('guest-order-days-container');
            const saveBtn = el('save-guest-order-btn');
            const today = new Date();
            const targetWeek = weekType === 'next' ? getWeekString(new Date(today.getTime() + 7 * 86400000)) : getWeekString(today);
            const weekDoc = await getDocument('order_list', targetWeek);
            const menu = weekDoc ? weekDoc.menu : null;
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const dayNames = { mon: __('mon'), tue: __('tue'), wed: __('wed'), thu: __('thu'), fri: __('fri') };

            if (!menu) { container.innerHTML = `<p class="text-center text-muted mt-2">${__('noMenu')}</p>`; saveBtn.classList.add('hidden'); return; }

            const allSelected = dayKeys.every(day => state.guestOrderSelection[day]);
            if (allSelected) {
                saveBtn.classList.remove('hidden');
                let summaryHTML = `<h4 style="color:var(--primary);margin-top:1.5rem;margin-bottom:0.5rem;">${__('orderedWeek')} ${targetWeek.split('_')[1]}</h4><ul class="staff-list">`;
                for (const dayKey of dayKeys) { summaryHTML += `<li class="staff-item summary-list-item"><div class="staff-details"><div class="staff-name">${dayNames[dayKey]}</div><div class="staff-dish">${parseDish(state.guestOrderSelection[dayKey])}</div></div></li>`; }
                container.innerHTML = summaryHTML + `</ul>`; return;
            }
            
            saveBtn.classList.add('hidden');
            const shiftToggleHTML = `<div class="form-group"><label class="form-label">${__('shift')}</label><div class="shift-toggle"><input type="radio" id="guest-shift-m" name="guest-shift" value="morning" ${state.guestShiftSelection === 'morning' ? 'checked' : ''}><label for="guest-shift-m">${__('morning')}</label><input type="radio" id="guest-shift-e" name="guest-shift" value="evening" ${state.guestShiftSelection === 'evening' ? 'checked' : ''}><label for="guest-shift-e">${__('evening')}</label></div></div>`;

            let tabsHTML = `<div class="tabs mt-2">`;
            for (const dayKey of dayKeys) { tabsHTML += `<button class="tab-btn guest-order-tab-btn ${state.guestCurrentOrderDay === dayKey ? 'active' : ''}" data-day-key="${dayKey}">${dayNames[dayKey]}</button>`; }
            tabsHTML += `</div>`;
            
            let daysContentHTML = '';
            for (const dayKey of dayKeys) {
                const dishes = menu[dayKey] || [];
                daysContentHTML += `<div id="guest-order-day-${dayKey}" class="${state.guestCurrentOrderDay === dayKey ? '' : 'hidden'}">`;
                if (Array.isArray(dishes) && dishes.length > 0) { daysContentHTML += `<div class="order-dish-list">${dishes.map(dish => `<div class="order-dish-item guest-dish-item" data-dish="${dish}" data-day-key="${dayKey}"><div class="order-dish-name">${parseDish(dish)}</div></div>`).join('')}</div>`; } 
                else { daysContentHTML += `<p class="text-center text-muted p-3">${__('noDishes')}</p><div class="order-dish-list"><div class="order-dish-item guest-dish-item" data-dish="Nghỉ" data-day-key="${dayKey}"><div class="order-dish-name">${__('rest')}</div></div></div>`; }
                daysContentHTML += `</div>`;
            }
            container.innerHTML = shiftToggleHTML + tabsHTML + daysContentHTML;
        }

        async function checkOrderNotification() {
            const todayTab = document.querySelector('.nav-item[data-tab="today"]');
            if (!todayTab || !state.currentUser) return;
            const today = new Date();
            const dayOfWeek = today.getDay();
            const hour = today.getHours();
            const userEmailKey = emailToKey(state.currentUser.email);
            
            const isCurrentWeekPeriod = (dayOfWeek >= 1 && dayOfWeek <= 3) || (dayOfWeek === 4 && hour < 15);

            const checkWeekString = isCurrentWeekPeriod ? getWeekString(today) : getWeekString(new Date(today.getTime() + 7 * 86400000));
            const weekDoc = await getDocument('order_list', checkWeekString);
            const hasOrder = weekDoc && weekDoc[userEmailKey] && weekDoc[userEmailKey].order === 'ordered';
            todayTab.classList.toggle('needs-attention', !hasOrder);
        }

        function autoResizeTextarea(element) { element.style.height = 'auto'; element.style.height = `${element.scrollHeight}px`; }

        document.body.addEventListener('change', async (e) => {
            const { id, name, value, type, checked } = e.target;
            if (id === 'stats-date-picker') { state.statsViewDate = new Date(value);  await renderAdminStats(); }
            else if (name === 'stats-mode') { state.statsViewMode = value; await renderStatsContent(); }
            else if (name === 'guest-week') { await renderGuestOrderDays(value); }
            else if (name === 'user-shift') { if (type === 'radio' && checked) state.userShiftSelection = value; }
            else if (name === 'guest-shift') { if (type === 'radio' && checked) state.guestShiftSelection = value; }
            else if (id === 'personnel-depart-select' && value === '__other__') {
                const newDepart = prompt('Nhập tên phòng ban mới:');
                if (newDepart && newDepart.trim()) {
                    const option = document.createElement('option'); option.value = newDepart.trim(); option.textContent = newDepart.trim(); option.selected = true;
                    e.target.insertBefore(option, e.target.querySelector('option[value="__other__"]'));
                } else { e.target.value = ''; }
            }
            else if (id === 'menu-file-input') {
                const file = e.target.files[0];
                if (!file) return;
                showLoader();
                try {
                    await loadXLSXLibrary();
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('menu')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
                    
                    let colMap = { mon: -1, tue: -1, wed: -1, thu: -1, fri: -1 };
                    let dataStartRow = -1;

                    for(let i=0; i < Math.min(rows.length, 20); i++) {
                         const row = rows[i].map(c => String(c || '').toLowerCase().trim());
                         
                         if (row.some(c => c === 'mon' || c === 'thứ 2')) {
                             dataStartRow = i + 1;
                             
                             row.forEach((cell, idx) => {
                                 const c = String(cell).toLowerCase().trim();
                                 
                                 if (colMap.mon === -1 && (c === 'mon' || c === 'thứ 2')) colMap.mon = idx;
                                 else if (colMap.tue === -1 && (c === 'tue' || c === 'thứ 3')) colMap.tue = idx;
                                 else if (colMap.wed === -1 && (c === 'wed' || c === 'thứ 4')) colMap.wed = idx;
                                 else if (colMap.thu === -1 && (c === 'thu' || c === 'thứ 5')) colMap.thu = idx;
                                 else if (colMap.fri === -1 && (c === 'fri' || c === 'thứ 6')) colMap.fri = idx;
                             });
                             break; 
                         }
                    }

                    if (dataStartRow === -1) throw new Error("Không tìm thấy dòng tiêu đề ngày (Mon/Thứ 2...)");

                    const extractedMenu = { mon: [], tue: [], wed: [], thu: [], fri: [] };
                    
                    for (let i = dataStartRow; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;

                        ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(day => {
                            const colIdx = colMap[day];
                            if (colIdx > -1) {
                                let val = row[colIdx];
                                if (val) {
                                    val = String(val).trim();
                                    
                                    const lowerVal = val.toLowerCase();
                                    const isGarbage = 
                                        lowerVal.startsWith('stt') || 
                                        lowerVal.startsWith('no.') || 
                                        lowerVal.includes('no order') || 
                                        lowerVal.includes('không đặt cơm');

                                    if (!isGarbage) {
                                        extractedMenu[day].push(val);
                                    }
                                }
                            }
                        });
                    }

                     for (const dayKey of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        const container = el(`menu-dishes-nextWeek-${dayKey}`);
                        if (container) {
                            container.innerHTML = ''; 
                            
                            const dishes = extractedMenu[dayKey];
                            dishes.forEach((dish, index) => {
                                const div = document.createElement('div');
                                div.style.display = 'flex';
                                div.style.gap = '0.5rem';
                                div.style.alignItems = 'center';
                                div.style.marginTop = '0.5rem';
                                
                                div.innerHTML = `
                                    <textarea class="form-textarea menu-dish-textarea" data-week="nextWeek" data-day="${dayKey}" data-index="${index}" placeholder="${__('oneDishPerLine')}" style="flex:1;min-height:40px;padding-bottom:10px;overflow:hidden;">${dish}</textarea>
                                    <button class="icon-btn remove-menu-dish-btn" data-week="nextWeek" data-day="${dayKey}" data-index="${index}"><i class="fas fa-times"></i></button>
                                `;
                                container.appendChild(div);
                            });

                            const emptyDiv = document.createElement('div');
                            emptyDiv.style.display = 'flex';
                            emptyDiv.style.gap = '0.5rem';
                            emptyDiv.style.alignItems = 'center';
                            emptyDiv.style.marginTop = '0.5rem';
                            emptyDiv.innerHTML = `
                                <textarea class="form-textarea menu-dish-textarea" data-week="nextWeek" data-day="${dayKey}" data-index="${dishes.length}" placeholder="${__('oneDishPerLine')}" style="flex:1;min-height:40px;padding-bottom:10px;overflow:hidden;"></textarea>
                                <button class="icon-btn remove-menu-dish-btn hidden" data-week="nextWeek" data-day="${dayKey}" data-index="${dishes.length}"><i class="fas fa-times"></i></button>
                            `;
                            container.appendChild(emptyDiv);
                        }
                    }
                    
                    document.querySelectorAll('.menu-dish-textarea').forEach(autoResizeTextarea);
                    showToast(`Đã nhập menu thành công!`);
                } catch (err) { 
                    console.error(err); 
                    showToast('Lỗi đọc file: ' + err.message, 'error'); 
                } finally { 
                    hideLoader(); 
                    e.target.value = ''; 
                }
            }

            else if (id === 'personnel-import-input') {
                const file = e.target.files[0];
                if (!file) return;
        
                if (!confirm("CẢNH BÁO: Hành động này sẽ:\n1. XÓA TOÀN BỘ dữ liệu nhân viên hiện tại.\n2. CẬP NHẬT LẠI danh sách phòng ban theo file Excel.\n\nBạn có chắc chắn muốn tiếp tục không?")) {
                    e.target.value = '';
                    return;
                }
        
                showLoader();
                try {
                    await loadXLSXLibrary();
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
        
                    if (!rows || rows.length === 0) throw new Error("File trống hoặc sai định dạng");
        
                    const newStaffData = {};
                    const newDepartmentsSet = new Set();
                    let count = 0;
                    
                    rows.forEach(row => {
                        const name = row['Tên'] || row['Name'] || row['name'] || Object.values(row)[0];
                        const email = row['Email'] || row['email'] || Object.values(row)[1];
                        let depart = row['Phòng ban'] || row['Department'] || row['department'] || Object.values(row)[2] || '';
                        
                        depart = String(depart).trim();
        
                        if (name && email && String(email).includes('@')) {
                            const key = emailToKey(String(email).trim());
                            newStaffData[key] = {
                                name: String(name).trim(),
                                email: String(email).trim(),
                                depart: depart,
                                lan: 'vi',
                                theme: 'dark'
                            };
                            
                            if (depart && depart.toLowerCase() !== 'unknown' && depart.toLowerCase() !== 'chưa rõ') {
                                newDepartmentsSet.add(depart);
                            }
                            
                            count++;
                        }
                    });
        
                    if (count === 0) throw new Error("Không tìm thấy dữ liệu hợp lệ (Cần cột Tên, Email)");
                    
                    const currentDoc = await getDocument("staff_list", "staffs") || {};
                    const guests = {};
                    Object.keys(currentDoc).forEach(k => {
                        if (k.startsWith('guest_')) guests[k] = currentDoc[k];
                    });
                    const finalData = { ...newStaffData, ...guests };
                    
                    await setDoc(doc(db, "staff_list", "staffs"), finalData);
        
                    const sortedDepartments = Array.from(newDepartmentsSet).sort();
                    await setDoc(doc(db, "admin_list", "departments"), { list: sortedDepartments });
        
                    showToast(`Đã nhập ${count} nhân viên và cập nhật ${sortedDepartments.length} phòng ban.`, 'success');
                    
                    await renderAdminPersonnel();
        
                } catch (err) {
                    console.error(err);
                    showToast('Lỗi nhập file: ' + err.message, 'error');
                } finally {
                    hideLoader();
                    e.target.value = '';
                }
            }
        });

        document.body.addEventListener('input', (e) => {
            if (e.target.classList.contains('menu-dish-textarea')) {
                autoResizeTextarea(e.target);
                const { week, day } = e.target.dataset;
                const container = el(`menu-dishes-${week}-${day}`);
                const allTextareas = container.querySelectorAll('.menu-dish-textarea');
                if (e.target === allTextareas[allTextareas.length - 1] && e.target.value.trim() !== '') {
                    const newIndex = allTextareas.length;
                    const newRow = document.createElement('div'); newRow.style.display = 'flex'; newRow.style.gap = '0.5rem'; newRow.style.alignItems = 'center';
                    newRow.innerHTML = `<textarea class="form-textarea menu-dish-textarea" data-week="${week}" data-day="${day}" data-index="${newIndex}" placeholder="${__('oneDishPerLine')}" style="flex:1;min-height:40px;padding-bottom:10px;overflow:hidden"></textarea><button class="icon-btn remove-menu-dish-btn hidden" data-week="${week}" data-day="${day}" data-index="${newIndex}"><i class="fas fa-times"></i></button>`;
                    container.appendChild(newRow);
                }
                e.target.nextElementSibling?.classList.toggle('hidden', e.target.value.trim() === '');
            }
        });

        document.body.addEventListener('click', async (e) => {
            if (!e.target.closest('#stats-options-btn') && !e.target.closest('.stats-dropdown')) {
                const dropdown = el('stats-dropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            }

            const target = e.target.closest('button, a, .profile-menu-item, .order-dish-item, .toggle-card-header, .toggle-option, .support-row, .status-icon-btn, .dropdown-item');
            if (!target) return;

            const { id, classList, dataset } = target;

            if (classList.contains('nav-item')) {
                if (dataset.tab === state.currentTab) return;
                document.querySelector('.nav-item.active').classList.remove('active'); target.classList.add('active');
                state.currentTab = dataset.tab; await render(); return;
            }
            else if (dataset.subtab) { state.adminSubTab = dataset.subtab; await renderAdmin(); return; }

            else if (id === 'login-btn') { showLoader(); try { await signInWithPopup(auth, provider); } catch { showToast(__('error'), 'error'); } finally { hideLoader(); } }
            else if (id === 'logout-menu-item') { if (confirm(__('logoutConfirm'))) { await signOut(auth); showToast(__('loggedOut')); } }
            
            else if (id === 'add-personnel-btn') {
                el('personnel-modal-title').textContent = 'Thêm nhân viên'; el('personnel-original-email-key').value = ''; el('personnel-name-input').value = ''; el('personnel-email-input').value = ''; el('personnel-depart-select').innerHTML = '';
                const departments = await getDepartmentsList();
                el('personnel-depart-select').innerHTML = '';
                departments.forEach(dept => {
                    const opt = document.createElement('option'); opt.value = dept; opt.textContent = dept; 
                    el('personnel-depart-select').appendChild(opt); 
                });
                el('personnel-modal').classList.remove('hidden');
            }
            else if (classList.contains('edit-personnel-btn')) {
                const userKey = dataset.key;
                const allStaff = await getDocument("staff_list", "staffs");
                const userData = allStaff[userKey];
                if (!userData) return;
                el('personnel-modal-title').textContent = 'Chỉnh sửa nhân viên'; el('personnel-original-email-key').value = userKey; el('personnel-name-input').value = userData.name; el('personnel-email-input').value = userData.email; el('personnel-depart-select').innerHTML = '';
                const departments = await getDepartmentsList(); 
                el('personnel-depart-select').innerHTML = '';
                departments.forEach(dept => {
                    const opt = document.createElement('option'); opt.value = dept; opt.textContent = dept; 
                    opt.selected = dept === userData.depart;
                    el('personnel-depart-select').appendChild(opt); 
                });
                el('personnel-modal').classList.remove('hidden');
            }
            else if (classList.contains('delete-personnel-btn')) { state.deleteTarget = { key: dataset.key, name: dataset.name }; el('delete-personnel-text').textContent = `Xóa nhân viên "${dataset.name}"?`; el('delete-personnel-modal').classList.remove('hidden'); }
            else if (id === 'save-personnel-btn') {
                showLoader();
                try {
                    const name = el('personnel-name-input').value.trim(); const email = el('personnel-email-input').value.trim(); let depart = el('personnel-depart-select').value; const originalKey = el('personnel-original-email-key').value;
                    if (!name || !email || !email.includes('@')) { showToast('Thông tin không hợp lệ', 'error'); hideLoader(); return; }
                    if (depart === '__other__') depart = prompt('Nhập tên phòng ban mới:').trim();
                    const newKey = emailToKey(email); const allStaff = await getDocument("staff_list", "staffs");
                    if ((!originalKey || originalKey !== newKey) && allStaff?.[newKey]) { showToast('Email đã tồn tại', 'error'); hideLoader(); return; }
                    const data = { name, email, depart, lan: 'vi' };
                    if (originalKey && originalKey !== newKey) await updateDoc(doc(db, "staff_list", "staffs"), { [originalKey]: deleteField(), [newKey]: data });
                    else await updateDoc(doc(db, "staff_list", "staffs"), { [newKey]: data });
                    showToast(originalKey ? 'Đã cập nhật' : 'Đã thêm'); el('personnel-modal').classList.add('hidden'); await renderAdminPersonnel();
                } catch { showToast(__('error'), 'error'); } finally { hideLoader(); }
            }
            else if (id === 'confirm-delete-personnel-btn') {
                showLoader(); try { await updateDoc(doc(db, "staff_list", "staffs"), { [state.deleteTarget.key]: deleteField() }); showToast('Đã xóa'); el('delete-personnel-modal').classList.add('hidden'); await renderAdminPersonnel(); } catch { showToast(__('error'), 'error'); } finally { hideLoader(); }
            }
            
            else if (classList.contains('lang-toggle-btn')) {
                if (dataset.lang === state.staffProfile.lan) return;
                showLoader(); 
                try { 
                    await updateDoc(doc(db, "staff_list", "staffs"), { [`${emailToKey(state.currentUser.email)}.lan`]: dataset.lang }); 
                    state.staffProfile.lan = dataset.lang; 
                    await render(); 
                    showToast(__('changeLangSuccess')); 
                } catch { showToast(__('error'), 'error'); } finally { hideLoader(); }
            }
            else if (classList.contains('theme-toggle-btn')) {
                const newTheme = dataset.theme;
                if (newTheme === state.staffProfile.theme) return;
                showLoader();
                try {
                    document.documentElement.setAttribute('data-theme', newTheme);
                    await updateDoc(doc(db, "staff_list", "staffs"), { [`${emailToKey(state.currentUser.email)}.theme`]: newTheme }); 
                    state.staffProfile.theme = newTheme; 
                    await render(); 
                    showToast('Đã đổi giao diện'); 
                } catch (err) { console.error(err); showToast(__('error'), 'error'); document.documentElement.setAttribute('data-theme', state.staffProfile.theme || 'dark'); } finally { hideLoader(); }
            }
            
            else if (target.closest('.toggle-card-header')) {
                const header = target.closest('.toggle-card-header');
                const targetId = header.dataset.target;
                const listEl = el(targetId);
                const icon = header.querySelector('.toggle-icon');
                if (listEl) {
                    const isHidden = listEl.classList.toggle('hidden');
                    if (icon) icon.classList.toggle('rotate');
                    header.classList.toggle('collapsed', isHidden);
                }
            } 
            else if (classList.contains('order-day-tab-btn')) {
                state.currentOrderDay = dataset.dayKey;
                // Nếu đang có state.reopenTargetWeek thì gọi renderReopen
                if (state.reopenTargetWeek) {
                     await renderReopenOrderSection(el('order-section-container'), state.reopenTargetWeek, state.reopenIsCurrentWeek);
                } else {
                    await renderOrderSection(el('order-section-container'));
                }
            } 
            else if (classList.contains('support-row')) {
                const targetId = dataset.target;
                const detailRow = el(targetId);
                if (detailRow) {
                    const isHidden = detailRow.classList.toggle('hidden');
                    target.classList.toggle('expanded', !isHidden);
                }
            }

            else if (target.closest('#stats-options-btn')) {
                const dropdown = el('stats-dropdown');
                if (dropdown) dropdown.classList.toggle('show');
            }
            else if (dataset.action === 'set-mode') {
                state.statsViewMode = dataset.mode;
                await renderAdminStats();
            }
            else if (target.closest('#stats-today-btn')) {
                state.statsViewDate = new Date();
                await renderAdminStats();
            }
            else if (id === 'prev-date-btn') {
                const d = new Date(state.statsViewDate);
                if (state.statsViewMode === 'day') d.setDate(d.getDate() - 1);
                else if (state.statsViewMode === 'week') d.setDate(d.getDate() - 7);
                else if (state.statsViewMode === 'month') d.setMonth(d.getMonth() - 1);
                state.statsViewDate = d;
                await renderAdminStats();
            }
            else if (id === 'next-date-btn') {
                const d = new Date(state.statsViewDate);
                if (state.statsViewMode === 'day') d.setDate(d.getDate() + 1);
                else if (state.statsViewMode === 'week') d.setDate(d.getDate() + 7);
                else if (state.statsViewMode === 'month') d.setMonth(d.getMonth() + 1);
                state.statsViewDate = d;
                await renderAdminStats();
            }
            else if (classList.contains('order-dish-item') && !classList.contains('guest-dish-item')) {
                const { dayKey, dish } = dataset;
                state.orderSelection[dayKey] = dish;
                
                const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri'];
                const currentIndex = dayOrder.indexOf(dayKey);
                if (currentIndex < dayOrder.length - 1) {
                    state.currentOrderDay = dayOrder[currentIndex + 1];
                }
                
                // Kiểm tra xem đang ở chế độ Reopen không
                if (state.reopenTargetWeek) {
                    renderReopenOrderSection(el('order-section-container'), state.reopenTargetWeek, state.reopenIsCurrentWeek);
                } else {
                    renderOrderSection(el('order-section-container'));
                }
            }
            else if (id === 'submit-order-btn' || id === 'submit-reopen-order-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const isReopen = id === 'submit-reopen-order-btn';
                    let targetWeek;
                    
                    if (isReopen) { 
                        if (!state.reopenTargetWeek) throw new Error("Lỗi: Không xác định được tuần đặt món.");
                        targetWeek = state.reopenTargetWeek; 
                    } else {
                        const dayOfWeek = today.getDay(); 
                        const hour = today.getHours();
                        const canOrderNextWeek = (dayOfWeek === 4 && hour >= 15) || dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0;
                        targetWeek = canOrderNextWeek ? getWeekString(new Date(today.getTime() + 7 * 86400000)) : getWeekString(today);
                    }
                    
                    const userKey = emailToKey(state.currentUser.email);
                    
                    // Logic yêu cầu chọn món: 
                    // Nếu Reopen Tuần này: chỉ cần check xem các ngày tương lai có được chọn chưa
                    // Nếu Tuần sau: cần check tất cả
                    const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
                    const dayMap = { mon: 1, tue: 2, wed: 3, thu: 4, fri: 5 };
                    const currentDayIndex = today.getDay();
                    
                    let requiredDays = dayKeys;
                    if (isReopen && state.reopenIsCurrentWeek) {
                         requiredDays = dayKeys.filter(d => dayMap[d] >= currentDayIndex);
                    }

                    // Kiểm tra các ngày bắt buộc
                    const missingDays = requiredDays.filter(day => !state.orderSelection[day]);
                    
                    if (missingDays.length > 0) {
                        // Nếu là Reopen tuần hiện tại, có thể người dùng giữ nguyên món cũ -> check DB
                        if(isReopen && state.reopenIsCurrentWeek) {
                            // Logic này hơi phức tạp, để đơn giản: 
                            // Nếu người dùng không chọn gì cả cho tương lai -> báo lỗi
                            const hasSelection = requiredDays.some(day => state.orderSelection[day]);
                            if(!hasSelection && requiredDays.length > 0) {
                                showToast('Vui lòng chọn món cho các ngày còn lại', 'error');
                                hideLoader();
                                return;
                            }
                        } else {
                             const selectedCount = Object.keys(state.orderSelection).filter(d => state.orderSelection[d]).length;
                             if(selectedCount === 0) {
                                showToast('Vui lòng chọn món', 'error');
                                hideLoader();
                                return;
                             }
                        }
                    }
                    
                    const currentWeekDoc = await getDocument('order_list', targetWeek);
                    const oldUserData = (currentWeekDoc && currentWeekDoc[userKey]) ? currentWeekDoc[userKey] : {};
            
                    const payload = { 
                        [userKey]: { 
                            name: state.staffProfile.name, 
                            email: state.currentUser.email, 
                            depart: state.staffProfile.depart || 'Unknown', 
                            shift: state.userShiftSelection, 
                            order: 'ordered' 
                        } 
                    };
                    
                    // --- QUAN TRỌNG: Merge dữ liệu cũ ---
                    for (const day of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        // Mặc định lấy món cũ
                        let finalDish = oldUserData[day];
                        
                        // Nếu người dùng có chọn món mới cho ngày này, dùng món mới
                        if (state.orderSelection[day]) {
                            const newDish = state.orderSelection[day];
                            const isNoOrder = newDish.toLowerCase().includes('không đặt cơm') || newDish.toLowerCase().includes('no order');
                            const prefix = isNoOrder ? '[ignore] ' : 'not: ';
                            finalDish = `${prefix}${newDish}`;
                        }
                        
                        // Nếu dữ liệu cũ là đã ăn (eaten), ưu tiên giữ nguyên trạng thái eaten
                        // Trừ khi admin reset, nhưng ở đây là user submit
                        if (oldUserData[day] && oldUserData[day].includes('eaten:')) {
                            finalDish = oldUserData[day];
                        }

                        // Gán vào payload nếu có giá trị
                        if (finalDish) {
                            payload[userKey][day] = finalDish;
                        }
                    }
                    
                    await setDoc(doc(db, 'order_list', targetWeek), payload, { merge: true });
                    
                    showToast(__('orderSuccess')); 
                    state.orderSelection = {}; 
                    state.currentOrderDay = 'mon'; 
                    state.reopenTargetWeek = null; 
                    state.reopenIsCurrentWeek = false;
                    
                    await render(); 
                    await checkOrderNotification();
            
                } catch (e) { 
                    console.error('Order error:', e); 
                    showToast(__('orderFailed') + ': ' + e.message, 'error'); 
                } finally { 
                    hideLoader(); 
                }
            }
            else if (dataset.action === 'skip-modal') {
                state.skipTarget = { day: dataset.day, dish: dataset.dish };
                el('skip-option-modal').classList.remove('hidden');
                const datalist = el('staff-suggestions');
                if (datalist.children.length === 0) {
                    const allStaff = await getDocument("staff_list", "staffs");
                    if (allStaff) {
                        const names = Object.values(allStaff).map(s => s.name).filter(n => n !== state.staffProfile.name).sort();
                        names.forEach(name => { const opt = document.createElement('option'); opt.value = name; datalist.appendChild(opt); });
                    }
                }
            }
            else if (classList.contains('status-icon-btn')) {
                const key = dataset.key;
                const weekType = dataset.weektype;
                const rowDetail = el(`row-detail-${key}`);
                const detailBlock = el(`detail-${weekType}-${key}`);
                const otherWeekType = weekType === 'this' ? 'next' : 'this';
                const otherDetailBlock = el(`detail-${otherWeekType}-${key}`);
                if (rowDetail && detailBlock) {
                    if (rowDetail.classList.contains('hidden')) {
                        rowDetail.classList.remove('hidden'); detailBlock.classList.remove('hidden');
                        if(otherDetailBlock) otherDetailBlock.classList.add('hidden');
                    } else {
                        if (!detailBlock.classList.contains('hidden')) { rowDetail.classList.add('hidden'); detailBlock.classList.add('hidden'); } 
                        else { if(otherDetailBlock) otherDetailBlock.classList.add('hidden'); detailBlock.classList.remove('hidden'); }
                    }
                }
            }
            else if (classList.contains('admin-save-user-btn')) {
                showLoader();
                try {
                    const userKey = dataset.key; 
                    const weekStr = dataset.weekstr; 
                    const weekType = dataset.weektype; 
                    
                    const shiftInput = document.querySelector(`input[name="shift-${weekType}-${userKey}"]:checked`);
                    const shift = shiftInput ? shiftInput.value : 'morning';

                    const allStaff = await getDocument("staff_list", "staffs");
                    const userProfile = allStaff[userKey];

                    const payload = {
                        [userKey]: {
                            name: userProfile.name,
                            email: userProfile.email,
                            depart: userProfile.depart,
                            shift: shift,
                            order: 'ordered'
                        }
                    };

                    const detailRow = el(`detail-${weekType}-${userKey}`);
                    if (!detailRow) throw new Error("Không tìm thấy khung chọn món. Vui lòng tải lại trang.");
                    
                    const selectedItems = detailRow.querySelectorAll('.mini-dish-item.selected');
                    
                    const currentWeekDoc = await getDocument('order_list', weekStr);
                    const oldOrderData = currentWeekDoc && currentWeekDoc[userKey] ? currentWeekDoc[userKey] : {};

                    ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(d => { 
                        if (oldOrderData[d]) payload[userKey][d] = oldOrderData[d]; 
                    });

                    selectedItems.forEach(item => {
                        const day = item.dataset.day;
                        const newDish = item.dataset.dish;
                        const oldDishString = oldOrderData[day] || '';

                        if (oldDishString.includes('eaten:') && oldDishString.includes(newDish)) {
                             payload[userKey][day] = oldDishString;
                        } else {
                            const isNoOrder = newDish.toLowerCase().includes('không đặt cơm') || newDish.toLowerCase().includes('no order');
                            const prefix = isNoOrder ? '[ignore] ' : 'not: ';
                            payload[userKey][day] = `${prefix}${newDish}`;
                        }
                    });

                    await setDoc(doc(db, 'order_list', weekStr), payload, { merge: true });
                    
                    showToast(`Đã cập nhật thực đơn (${weekType === 'this' ? 'Tuần này' : 'Tuần sau'})`);
                    await renderAdminSupport();

                } catch (err) {
                    console.error(err);
                    showToast('Lỗi khi lưu: ' + err.message, 'error');
                } finally {
                    hideLoader();
                }
            }
            else if (classList.contains('btn-delete-order')) {
                const userKey = dataset.key;
                const weekStr = dataset.weekstr;
                const weekType = dataset.weektype;

                if (!confirm(`Bạn có chắc muốn hủy các món CHƯA ĂN của người này trong ${weekType === 'this' ? 'Tuần này' : 'Tuần sau'}?`)) return;

                showLoader();
                try {
                    const weekDoc = await getDocument('order_list', weekStr);
                    const userData = weekDoc ? weekDoc[userKey] : null;

                    if (!userData) {
                        showToast('Không tìm thấy dữ liệu người dùng.', 'error');
                        hideLoader();
                        return;
                    }

                    const updates = {};
                    let hasEatenData = false;
                    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];

                    days.forEach(day => {
                        const dishValue = userData[day];
                        if (dishValue && dishValue.includes('eaten:')) {
                            hasEatenData = true;
                        } 
                        else {
                            updates[`${userKey}.${day}`] = deleteField();
                        }
                    });

                    if (!hasEatenData) {
                        await updateDoc(doc(db, 'order_list', weekStr), {
                            [userKey]: deleteField()
                        });
                        showToast('Đã xóa toàn bộ đơn đặt hàng.');
                    } else {

                        updates[`${userKey}.order`] = 'cancelled'; 
                        if (Object.keys(updates).length > 0) {
                            await updateDoc(doc(db, 'order_list', weekStr), updates);
                        }
                        showToast('Đã hủy các món chưa ăn. Giữ lại lịch sử món đã ăn.');
                    }

                    await renderAdminSupport();
                } catch (err) {
                    console.error(err);
                    showToast('Lỗi khi hủy: ' + err.message, 'error');
                } finally {
                    hideLoader();
                }
            }
            else if (dataset.action === 'eat-gift') {
                showLoader(); try { const weekString = getWeekString(new Date()); const { giverKey, day, dish } = dataset; await updateDoc(doc(db, 'order_list', weekString), { [`${giverKey}.${day}`]: `eaten: ${dish}` }); showToast('Đã xác nhận ăn món được nhường!'); await render(); } catch (err) { console.error(err); showToast(__('error'), 'error'); } finally { hideLoader(); }
            }
            else if (id === 'add-department-btn') {
                el('department-modal-title').textContent = 'Thêm phòng ban'; el('department-original-name').value = ''; el('department-name-input').value = ''; el('department-modal').classList.remove('hidden'); el('department-name-input').focus();
            }
            else if (classList.contains('edit-department-btn')) {
                const name = dataset.name; el('department-modal-title').textContent = 'Đổi tên & Đồng bộ'; el('department-original-name').value = name; el('department-name-input').value = name; el('department-modal').classList.remove('hidden'); el('department-name-input').focus();
            }
            else if (id === 'save-department-btn') {
                showLoader();
                try {
                    const newName = el('department-name-input').value.trim(); const oldName = el('department-original-name').value;
                    if (!newName) { showToast('Vui lòng nhập tên', 'error'); hideLoader(); return; }
                    const deptDocRef = doc(db, "admin_list", "departments"); const departments = await getDepartmentsList();
                    if (departments.includes(newName) && newName !== oldName) { showToast('Tên phòng ban đã tồn tại', 'error'); hideLoader(); return; }
                    if (oldName) {
                        const index = departments.indexOf(oldName);
                        if (index > -1) {
                            departments[index] = newName; departments.sort(); await updateDoc(deptDocRef, { list: departments });
                            const allStaff = await getDocument("staff_list", "staffs"); const staffUpdates = {}; let affectedUserKeys = []; 
                            Object.entries(allStaff).forEach(([key, user]) => { if (user.depart === oldName) { staffUpdates[`${key}.depart`] = newName; affectedUserKeys.push(key); } });
                            if (affectedUserKeys.length > 0) { await updateDoc(doc(db, "staff_list", "staffs"), staffUpdates); }
                            if (affectedUserKeys.length > 0) {
                                const targetWeeks = getWeeksInMonth(new Date());
                                await Promise.all(targetWeeks.map(async (weekStr) => {
                                    const weekDocRef = doc(db, "order_list", weekStr); const weekDoc = await getDocument("order_list", weekStr);
                                    if (weekDoc) {
                                        const orderUpdates = {}; let hasUpdate = false;
                                        Object.keys(weekDoc).forEach(userKey => { if (weekDoc[userKey] && typeof weekDoc[userKey] === 'object') { if (weekDoc[userKey].depart === oldName) { orderUpdates[`${userKey}.depart`] = newName; hasUpdate = true; } } });
                                        if (hasUpdate) { await updateDoc(weekDocRef, orderUpdates); }
                                    }
                                }));
                            }
                            showToast(`Đã đổi tên và đồng bộ dữ liệu thống kê tháng.`);
                        }
                    } else {
                        departments.push(newName); departments.sort(); await setDoc(deptDocRef, { list: departments }, { merge: true }); showToast('Đã thêm phòng ban');
                    }
                    el('department-modal').classList.add('hidden'); await renderAdminPersonnel();
                } catch (err) { console.error(err); showToast('Lỗi: ' + err.message, 'error'); } finally { hideLoader(); }
            }
            else if (classList.contains('delete-department-btn')) {
                const deptToDelete = dataset.name; state.deleteTarget = { name: deptToDelete };
                const departments = await getDepartmentsList(); const availableDepartments = departments.filter(d => d !== deptToDelete);
                if (availableDepartments.length === 0) { showToast('Không còn phòng ban nào khác để chuyển nhân sự. Vui lòng tạo thêm phòng ban trước.', 'error'); return; }
                const transferSelect = el('transfer-department-select'); transferSelect.innerHTML = '';
                availableDepartments.forEach(dept => { const opt = document.createElement('option'); opt.value = dept; opt.textContent = dept; transferSelect.appendChild(opt); });
                el('delete-department-text').textContent = `Bạn đang xóa phòng ban: "${deptToDelete}"`; el('delete-department-modal').classList.remove('hidden');
            }
            else if (id === 'confirm-delete-department-btn') {
                showLoader();
                try {
                    const oldName = state.deleteTarget.name; const newName = el('transfer-department-select').value;
                    if (!newName) { showToast('Vui lòng chọn phòng ban để chuyển tới', 'error'); hideLoader(); return; }
                    const deptDocRef = doc(db, "admin_list", "departments"); let departments = await getDepartmentsList();
                    departments = departments.filter(d => d !== oldName); await updateDoc(deptDocRef, { list: departments });
                    const allStaff = await getDocument("staff_list", "staffs"); const staffUpdates = {}; let affectedUserKeys = [];
                    Object.entries(allStaff).forEach(([key, user]) => { if (user.depart === oldName) { staffUpdates[`${key}.depart`] = newName; affectedUserKeys.push(key); } });
                    if (affectedUserKeys.length > 0) { await updateDoc(doc(db, "staff_list", "staffs"), staffUpdates); }
                    if (affectedUserKeys.length > 0) {
                        const targetWeeks = getWeeksInMonth(new Date());
                        await Promise.all(targetWeeks.map(async (weekStr) => {
                            const weekDocRef = doc(db, "order_list", weekStr); const weekDoc = await getDocument("order_list", weekStr);
                            if (weekDoc) {
                                const orderUpdates = {}; let hasUpdate = false;
                                Object.keys(weekDoc).forEach(userKey => { if (weekDoc[userKey] && typeof weekDoc[userKey] === 'object') { if (weekDoc[userKey].depart === oldName) { orderUpdates[`${userKey}.depart`] = newName; hasUpdate = true; } } });
                                if (hasUpdate) { await updateDoc(weekDocRef, orderUpdates); }
                            }
                        }));
                    }
                    showToast(`Đã xóa "${oldName}" và chuyển ${affectedUserKeys.length} nhân sự sang "${newName}".`);
                    el('delete-department-modal').classList.add('hidden'); await renderAdminPersonnel();
                } catch (err) { console.error(err); showToast('Lỗi: ' + err.message, 'error'); } finally { hideLoader(); }
            }
            else if (target.closest('.toggle-card-header')) {
                const header = target.closest('.toggle-card-header'); const targetId = header.dataset.target; const listEl = el(targetId); const icon = header.querySelector('.toggle-icon');
                if (listEl) { const isHidden = listEl.classList.toggle('hidden'); if (icon) icon.classList.toggle('rotate'); header.classList.toggle('collapsed', isHidden); }
            } 
            else if (id === 'skip-everyone-btn') { await processSkip('Everyone'); }
            else if (id === 'skip-specific-btn') { const receiver = el('skip-receiver-input').value.trim(); if (!receiver) return showToast('Vui lòng nhập tên người nhận', 'error'); await processSkip(receiver); }
            else if (dataset.action === 'eaten') { showLoader(); try { const weekString = getWeekString(new Date()); const { day } = dataset; const userKey = emailToKey(state.currentUser.email); const weekDoc = await getDocument('order_list', weekString); const currentDishString = weekDoc[userKey][day]; const { dish } = parseDishValue(currentDishString); await updateDoc(doc(db, 'order_list', weekString), { [`${userKey}.${day}`]: `eaten: ${dish}` }); showToast(__('eatenSuccess')); await render(); } catch (err) { console.error(err); showToast(__('error'), 'error'); } finally { hideLoader(); } }
            else if (classList.contains('mark-eaten-btn')) { e.preventDefault(); e.stopPropagation(); showLoader(); try { const weekString = getWeekString(new Date()); const { key: userKey, day } = dataset; const weekDoc = await getDocument('order_list', weekString); const { dish } = parseDishValue(weekDoc[userKey][day]); await updateDoc(doc(db, 'order_list', weekString), { [`${userKey}.${day}`]: `eaten: ${dish}` }); showToast(__('eatenSuccess')); const updatedDoc = await getDocument('order_list', weekString); updateStaffListView(updatedDoc); } catch (err) { console.error(err); showToast(__('error'), 'error'); } finally { hideLoader(); } }                
            else if (id === 'menu-filter-btn') { state.menuFilterMode = state.menuFilterMode === 'auto' ? 'all' : 'auto'; const weekDoc = await getDocument('order_list', getWeekString(new Date())); if (weekDoc) updateStaffListView(weekDoc); } 
            else if (id === 'stats-today-btn') { state.statsViewDate = new Date(); el('stats-date-picker').value = state.statsViewDate.toISOString().split('T')[0]; await renderStatsContent(); } 
            else if (classList.contains('remove-menu-dish-btn')) { target.closest('div[style*="display:flex"]').remove(); } 
            else if (id === 'export-stats-btn') {
                try { await loadXLSXLibrary(); const wb = XLSX.utils.book_new(); const tables = el('stats-content').querySelectorAll('table'); if (tables.length === 0) { showToast(__('noData'), 'error'); return; } tables.forEach((table, idx) => { const ws = XLSX.utils.table_to_sheet(table); const sheetName = state.statsViewMode === 'day' ? (idx === 0 ? __('morning') : __('evening')) : __('stats'); XLSX.utils.book_append_sheet(wb, ws, sheetName); }); XLSX.writeFile(wb, `stats_${state.statsViewDate.toISOString().split('T')[0]}.xlsx`); } catch { showToast(__('error'), 'error'); }
            } 
            else if (id === 'export-personnel-btn') {
                try { await loadXLSXLibrary(); const allStaff = await getDocument("staff_list", "staffs"); const data = Object.entries(allStaff).filter(([key]) => !key.startsWith('guest_')).map(([_, p]) => ({ [__('name')]: p.name, [__('email')]: p.email, [__('department')]: p.depart || '-' })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), __('personnel')); XLSX.writeFile(wb, 'personnel.xlsx'); } catch { showToast(__('error'), 'error'); }
            } 
            else if (id === 'add-guest-order-btn') { state.guestOrderSelection = {}; state.guestCurrentOrderDay = 'mon'; await renderGuestOrderDays('this'); el('guest-order-modal').classList.remove('hidden'); } 
            else if (classList.contains('guest-order-tab-btn')) { state.guestCurrentOrderDay = dataset.dayKey; await renderGuestOrderDays(document.querySelector('input[name="guest-week"]:checked').value); } 
            else if (classList.contains('guest-dish-item')) { state.guestOrderSelection[dataset.dayKey] = dataset.dish; const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri']; if (dayOrder.indexOf(dataset.dayKey) < 4) state.guestCurrentOrderDay = dayOrder[dayOrder.indexOf(dataset.dayKey) + 1]; await renderGuestOrderDays(document.querySelector('input[name="guest-week"]:checked').value); } 
            else if (id === 'save-guest-order-btn') {
                showLoader(); try { const guestName = el('guest-name-input').value.trim(); if (!guestName) { showToast('Vui lòng nhập tên khách.', 'error'); hideLoader(); return; } const targetWeek = document.querySelector('input[name="guest-week"]:checked').value === 'next' ? getWeekString(new Date(Date.now() + 7*864e5)) : getWeekString(new Date()); const guestKey = `guest_${Date.now()}`; const payload = { [guestKey]: { name: guestName, depart: el('guest-depart-input').value.trim(), shift: state.guestShiftSelection, order: 'ordered' } }; for (const day in state.guestOrderSelection) { const dishName = state.guestOrderSelection[day]; const isNoOrder = dishName.toLowerCase().includes('không đặt cơm'); const prefix = isNoOrder ? '[ignore] ' : 'not: '; payload[guestKey][day] = `${prefix}${dishName}`; } await setDoc(doc(db, 'order_list', targetWeek), payload, { merge: true }); showToast(`${__('orderSuccess')} cho khách ${guestName}`); state.guestOrderSelection = {}; el('guest-order-modal').classList.add('hidden'); await renderAdmin(); } catch(err) { console.error(err); showToast(__('orderFailed'), 'error'); } finally { hideLoader(); }
            }
            else if (classList.contains('reopen-order-btn')) { 
                state.reopenTarget = { key: dataset.key, name: dataset.name, weekStr: dataset.weekstr }; 
                el('reopen-order-modal-title').textContent = `${__('reopenOrderFor')} ${dataset.name}?`; 
                const weekLabel = dataset.weekstr.split('_')[1];
                el('reopen-order-text').innerHTML = `${__('reopenConfirmText')}<br><br><strong>Áp dụng cho tuần: ${weekLabel}</strong>`; 
                el('reopen-order-modal').classList.remove('hidden'); 
            } 
            else if(id === 'confirm-reopen-order-btn'){ 
                showLoader(); 
                try { 
                    const targetWeekString = state.reopenTarget.weekStr; 
                    await setDoc(doc(db, 'order_list', targetWeekString), { 
                        [state.reopenTarget.key]: { order: 'reopen', name: state.reopenTarget.name } 
                    }, { merge: true }); 
                    
                    showToast(__('reopenSuccess')); 
                    el('reopen-order-modal').classList.add('hidden'); 
                    
                    if (state.reopenTarget.key === emailToKey(state.currentUser.email)) { 
                        state.orderSelection = {}; 
                        state.currentTab = 'today'; 
                        await render(); 
                    } else { 
                        await renderAdmin(); 
                    } 
                } catch (err) { 
                    console.error(err);
                    showToast(__('error'), 'error'); 
                } finally { 
                    hideLoader(); 
                } 
            } 
            else if(dataset.modal) el(dataset.modal).classList.toggle('hidden');
            else if (id === 'edit-menu-btn') { state.isEditingMenu = true; await renderAdminMenu(); }
            else if (id === 'cancel-edit-menu-btn') { state.isEditingMenu = false; await renderAdminMenu(); }
            else if (id === 'save-menu-nextWeek') {
                showLoader(); try { const weekStr = dataset.week; const weekKey = 'nextWeek'; const weekDoc = await getDocument('order_list', weekStr) || {}; const menuToSave = { ...(weekDoc.menu || {}) }; let hasData = false; for (const day of ['mon', 'tue', 'wed', 'thu', 'fri']) { const container = el(`menu-dishes-${weekKey}-${day}`); if (container) { const newDishes = Array.from(container.querySelectorAll('.menu-dish-textarea')).map(t => t.value.trim()).filter(Boolean); const existingDishes = menuToSave[day] || []; const finalDishes = [...existingDishes, ...newDishes]; if (finalDishes.length > 0) { hasData = true; if (!finalDishes.some(d => d.includes('Không đặt cơm'))) finalDishes.push('Không đặt cơm | No order'); } menuToSave[day] = finalDishes; } } await setDoc(doc(db, 'order_list', weekStr), { menu: menuToSave }, { merge: true }); showToast(__('menuSaved')); state.isEditingMenu = false; await renderAdminMenu(); } catch (err) { console.error(err); showToast(__('error'), 'error'); } finally { hideLoader(); }
            }
        });

        async function main() {
            showLoader();
            try {
                await setPersistence(auth, browserLocalPersistence);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.currentUser = user; state.authReady = true;
                        try { await syncUserProfile(); updateUIForUser(user); await render(); showToast(`${__('hi')}, ${getFirstName(state.staffProfile.name)}!`); await checkOrderNotification(); } catch(e) { showToast(e.message, 'error'); await signOut(auth); }
                    } else {
                        state.currentUser = null; state.isAdmin = false; state.authReady = true;
                        Object.assign(state, { orderSelection: {}, currentOrderDay: 'mon', userShiftSelection: 'morning', guestOrderSelection: {}, reopenTargetWeek: null });
                        updateUIForUser(null);
                    }
                    hideLoader();
                });
            } catch { hideLoader(); showToast('Lỗi khởi tạo', 'error'); }
        }
        main();
    </script>
</body>
</html>
