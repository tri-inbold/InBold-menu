<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu - Public Monitor</title>
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js">
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3cpath fill='%23667eea' d='M63.9 14.4C63.1 6.2 56.2 0 48 0s-15.1 6.2-16 14.3L17.9 149.7c-1.3 6-1.9 12.1-1.9 18.2 0 45.9 35.1 83.6 80 87.7L96 480c0 17.7 14.3 32 32 32s32-14.3 32-32l0-224.4c44.9-4.1 80-41.8 80-87.7 0-6.1-.6-12.2-1.9-18.2L223.9 14.3C223.1 6.2 216.2 0 208 0s-15.1 6.2-15.9 14.4L178.5 149.9c-.6 5.7-5.4 10.1-11.1 10.1-5.8 0-10.6-4.4-11.2-10.2L143.9 14.6C143.2 6.3 136.3 0 128 0s-15.2 6.3-15.9 14.6L99.8 149.8c-.5 5.8-5.4 10.2-11.2 10.2-5.8 0-10.6-4.4-11.1-10.1L63.9 14.4zM448 0C432 0 320 32 320 176l0 112c0 35.3 28.7 64 64 64l32 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-448c0-17.7-14.3-32-32-32z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        :root { 
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #4299e1;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius-md: 12px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--dark-bg); color: var(--text); line-height: 1.5; font-size: 14px; }
        #app { max-width: 900px; margin: 0 auto; min-height: 100vh; padding: 1.5rem; display: flex; flex-direction: column; }
        
        .card { background: var(--card-bg); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 1.5rem; justify-content: center; }
        .tab-btn { padding: 14px 32px; border-radius: 50px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; font-weight: 600; font-size: 16px; }
        .tab-btn:hover { background: var(--card-hover); color: var(--text); }
        .tab-btn.active { background: var(--gradient-1); border-color: transparent; color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        
        .search-bar { display: flex; gap: 8px; margin-bottom: 1rem; }
        .search-wrapper { position: relative; flex: 1; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .icon-btn { width: 42px; height: 42px; border-radius: 8px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .department-group { margin-bottom: 1.5rem; }
        .department-header { color: var(--primary-light); padding: 0.5rem 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 0.5rem; }
        
        .staff-list { list-style: none; }
        .staff-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: rgba(30, 41, 59, 0.6); border-radius: 8px; margin-bottom: 6px; border: 1px solid transparent; transition: all 0.2s; }
        .staff-item:hover { background: rgba(30, 41, 59, 1); border-color: rgba(102, 126, 234, 0.3); }
        .staff-item.eaten { opacity: 0.5; background: rgba(30, 41, 59, 0.3); }
        .staff-item.skipped { border-left: 3px solid var(--warning); background: rgba(237, 137, 54, 0.05); }
        
        .staff-name { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 3px; }
        .staff-dish { font-size: 14px; color: var(--text-muted); }
        .staff-status-icon { margin-left: 10px; font-size: 16px; width: 24px; text-align: center; }
        .status-eaten { color: var(--success); }
        .status-skip { color: var(--warning); }
        
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(102, 126, 234, 0.1); }
        th, td { padding: 12px 15px; text-align: left; font-size: 13px; border-bottom: 1px solid var(--border); }
        th { font-weight: 600; color: var(--primary-light); text-transform: uppercase; font-size: 12px; }
        tr:last-child td { border-bottom: none; }
        .stats-date-controls { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 1.5rem; }
        .date-display { font-size: 16px; font-weight: 600; min-width: 150px; text-align: center; position: relative; }
        .date-display::before { content: '*'; position: absolute; left: -12px; top: 0; }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        #loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .static-logo { width: 150px; height: auto; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 6px; }
        .badge-morning { background: rgba(66, 153, 225, 0.2); color: #63b3ed; }
        .badge-evening { background: rgba(128, 90, 213, 0.2); color: #b794f4; }

        @media (max-width: 768px) {
            #app { padding: 1rem; }
            .tab-btn { padding: 8px 16px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="static-logo" style="color:white; font-size: 24px; font-weight:bold; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-circle-notch fa-spin"></i> Loading...
        </div>
    </div>

    <div id="app">
        <div class="tabs">
            <button class="tab-btn active" data-tab="list">Hôm nay</button>
            <button class="tab-btn" data-tab="stats">Danh sách đặt</button>
        </div>

        <main id="main-content"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const state = {
            currentTab: 'list',
            statsViewDate: new Date(), 
            filterMode: 'auto'
        };

        const el = (id) => document.getElementById(id);
        const showLoader = () => el('loader').classList.remove('hidden');
        const hideLoader = () => el('loader').classList.add('hidden');

        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        
        const toLocalISOString = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date - offset)).toISOString().slice(0, 10);
            return localISOTime;
        };

        const parseDishValue = (rawString) => {
            if (!rawString) return { status: 'not', dish: '' };
            if (rawString.startsWith('[ignore]')) return { status: 'ignore', dish: rawString.substring(8).trim() };
            if (rawString.startsWith('giveup[')) {
                const closeBracket = rawString.indexOf(']');
                const receiver = rawString.substring(7, closeBracket);
                const dish = rawString.substring(closeBracket + 2).trim();
                return { status: 'giveup', receiver, dish };
            }
            const prefixes = ['eaten:', 'giveup:', 'not:', 'placeholder:'];
            for (const prefix of prefixes) {
                if (rawString.startsWith(prefix)) {
                    let status = prefix.replace(':', '');
                    if (status === 'placeholder') status = 'ignore';
                    return { status: status, dish: rawString.substring(prefix.length).trim() };
                }
            }
            return { status: 'not', dish: rawString };
        };

        const parseDish = (rawString) => {
            const { dish } = parseDishValue(rawString);
            if (!dish) return '';
            const parts = dish.replace('[ignore]', '').trim().split('|');
            return parts[0].trim();
        };

        async function getDocument(collection, documentId) {
            try {
                const docRef = doc(db, collection, documentId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) {
                console.error("Lỗi đọc dữ liệu:", error);
                return null;
            }
        }

        async function render() {
            showLoader();
            const mainContent = el('main-content');
            mainContent.innerHTML = ''; 

            if (state.currentTab === 'list') {
                await renderList(mainContent);
            } else {
                await renderStats(mainContent);
            }
            hideLoader();
        }

        async function renderList(container) {
            const today = new Date();
            const dayKey = getDayKey(today);
            const weekString = getWeekString(today);
            
            const headerHtml = `
                <div class="search-bar">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="Tìm kiếm tên nhân viên...">
                    </div>
                    <button id="toggle-filter-btn" class="icon-btn" title="Chuyển chế độ xem">
                        <i class="fas ${state.filterMode === 'all' ? 'fa-list' : (today.getHours() < 14 ? 'fa-sun' : 'fa-moon')}"></i>
                    </button>
                    <button id="reload-btn" class="icon-btn" title="Làm mới">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="list-container"></div>
            `;
            container.innerHTML = headerHtml;

            const weekData = await getDocument('order_list', weekString);
            
            if (!weekData) {
                el('list-container').innerHTML = `<div class="card text-center text-muted">Chưa có dữ liệu cho tuần này.</div>`;
                return;
            }

            el('search-input').addEventListener('input', (e) => updateListView(weekData, dayKey, e.target.value));
            el('reload-btn').addEventListener('click', () => render());
            el('toggle-filter-btn').addEventListener('click', () => {
                state.filterMode = state.filterMode === 'auto' ? 'all' : 'auto';
                renderList(container); 
            });

            updateListView(weekData, dayKey, '');
        }

        function updateListView(weekData, dayKey, searchTerm) {
            const container = el('list-container');
            const hour = new Date().getHours();
            
            const orders = Object.entries(weekData)
                .filter(([key, val]) => {
                    return key !== 'menu' && 
                           val[dayKey] && 
                           val.order !== 'reopen' && 
                           val.name && 
                           val.name.toLowerCase().includes(searchTerm.toLowerCase());
                })
                .map(([key, val]) => ({ ...val, key, rawDish: val[dayKey] }));

            const generateSection = (list, title) => {
                if (list.length === 0) return '';
                
                const giveupList = [];
                const notEatenList = [];
                const eatenList = [];
                
                list.forEach(o => {
                    const { status } = parseDishValue(o.rawDish);
                    if (status === 'ignore' || status === 'placeholder') return;
                    
                    if (status === 'giveup') {
                        giveupList.push(o);
                    } else if (status === 'eaten') {
                        eatenList.push(o);
                    } else {
                        notEatenList.push(o);
                    }
                });

                let html = `<div style="margin-bottom: 2rem;">
                    <h3 style="color:white; border-bottom: 2px solid var(--primary); padding-bottom:5px; margin-bottom:15px;">${title} (${list.length})</h3>`;
                
                const renderGroup = (groupList, groupTitle) => {
                    if (groupList.length === 0) return '';
                    const sorted = groupList.sort((a,b) => a.name.localeCompare(b.name));
                    html += `<div class="department-group"><div class="department-header">${groupTitle}</div><ul class="staff-list">`;
                    
                    sorted.forEach(order => {
                        const { status, receiver } = parseDishValue(order.rawDish);

                        let statusClass = '';
                        let icon = '';
                        let extra = '';

                        if (status === 'eaten') {
                            statusClass = 'eaten';
                            icon = '<i class="fas fa-check-circle status-eaten"></i>';
                        } else if (status === 'giveup') {
                            statusClass = 'skipped';
                            icon = '<i class="fas fa-gift status-skip"></i>';
                            if (receiver && receiver !== 'Everyone' && receiver !== 'Mọi người') {
                                extra = `<div style="font-size:11px;color:var(--warning); margin-top:2px;"> <i class="fas fa-arrow-right"></i> ${receiver}</div>`;
                            } else {
                                extra = `<div style="font-size:11px;color:var(--warning); margin-top:2px;"> <i class="fas fa-users"></i> Đã nhượng</div>`;
                            }
                        }

                        html += `
                            <li class="staff-item ${statusClass}">
                                <div style="flex:1">
                                    <div class="staff-name">${order.name}</div>
                                    <div class="staff-dish">${parseDish(order.rawDish)}</div>
                                    ${extra}
                                </div>
                                <div class="staff-status-icon">${icon}</div>
                            </li>
                        `;
                    });
                    html += `</ul></div>`;
                };

                renderGroup(giveupList, 'Nhượng');
                renderGroup(notEatenList, 'Chưa ăn');
                renderGroup(eatenList, 'Đã ăn');
                
                html += `</div>`;
                return html;
            };

            const morningShift = orders.filter(o => {
                const {status} = parseDishValue(o.rawDish);
                return (status !== 'ignore') && (o.shift === 'morning' || o.shift === 'M');
            });
            
            const eveningShift = orders.filter(o => {
                const {status} = parseDishValue(o.rawDish);
                return (status !== 'ignore') && (o.shift === 'evening' || o.shift === 'E');
            });

            let contentHtml = '';
            
            if (state.filterMode === 'all') {
                contentHtml += generateSection(morningShift, '<i class="fas fa-sun"></i> Ca Sáng');
                contentHtml += generateSection(eveningShift, '<i class="fas fa-moon"></i> Ca Chiều');
            } else {
                if (hour < 14) {
                    contentHtml += generateSection(morningShift, '<i class="fas fa-sun"></i> Ca Sáng');
                    if (eveningShift.length > 0) contentHtml += `<div class="text-center text-muted" style="margin-top:20px"><small>Ca chiều sẽ hiển thị tự động sau 14:00</small></div>`;
                } else {
                    contentHtml += generateSection(eveningShift, '<i class="fas fa-moon"></i> Ca Chiều');
                    if (morningShift.length > 0) contentHtml += `<div class="text-center text-muted" style="margin-top:20px"><small>Xem ca sáng bằng cách bấm nút lọc phía trên</small></div>`;
                }
            }

            if (!contentHtml.trim()) {
                container.innerHTML = `<div class="card text-center text-muted">Không tìm thấy nhân viên nào đặt món hôm nay.</div>`;
            } else {
                container.innerHTML = contentHtml;
            }
        }

        async function renderStats(container) {
            const dateStr = toLocalISOString(state.statsViewDate);
            const dayKey = getDayKey(state.statsViewDate);
            const weekStr = getWeekString(state.statsViewDate);

            const controlsHtml = `
                <div style="margin-bottom: 1.5rem;">
                    <div class="stats-date-controls">
                        <button class="icon-btn" id="prev-day"><i class="fas fa-chevron-left"></i></button>
                        <button class="icon-btn" id="today-btn" title="Hôm nay" style="background:var(--primary); color:white;"><i class="fas fa-calendar-day"></i></button>
                        <div style="position:relative;">
                            <div class="date-display">${state.statsViewDate.toLocaleDateString('vi-VN')}</div>
                            <input type="date" id="date-picker" value="${dateStr}" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
                        </div>
                        <button class="icon-btn" id="next-day"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="stats-table-container"></div>
            `;
            container.innerHTML = controlsHtml;

            el('date-picker').addEventListener('change', (e) => {
                const parts = e.target.value.split('-');
                state.statsViewDate = new Date(parts[0], parts[1] - 1, parts[2]);
                renderStats(container);
            });
            el('prev-day').addEventListener('click', () => {
                state.statsViewDate.setDate(state.statsViewDate.getDate() - 1);
                renderStats(container);
            });
            el('next-day').addEventListener('click', () => {
                state.statsViewDate.setDate(state.statsViewDate.getDate() + 1);
                renderStats(container);
            });
            el('today-btn').addEventListener('click', () => {
                state.statsViewDate = new Date();
                renderStats(container);
            });

            const weekDoc = await getDocument('order_list', weekStr);
            const statsContainer = el('stats-table-container');

            if (!weekDoc) {
                statsContainer.innerHTML = `<p class="text-center text-muted">Chưa có dữ liệu cho ngày này.</p>`;
                return;
            }

            const stats = { morning: {}, evening: {} };
            let hasData = false;

            Object.entries(weekDoc).forEach(([key, val]) => {
                if (key === 'menu' || typeof val !== 'object' || !val) return;
                if (val.order === 'reopen' || !val[dayKey]) return;

                const { status } = parseDishValue(val[dayKey]);
                
                if (status === 'ignore' || status === 'placeholder') return;

                const dish = parseDish(val[dayKey]);
                if (!dish) return;

                const rawShift = String(val.shift || 'morning').toLowerCase().trim();
                const shiftKey = (rawShift.includes('e') || rawShift === 'evening') ? 'evening' : 'morning';

                if (!stats[shiftKey][dish]) {
                    stats[shiftKey][dish] = { ordered: 0 };
                }

                hasData = true;
                stats[shiftKey][dish].ordered++;
            });

            if (!hasData) {
                statsContainer.innerHTML = `<p class="text-center text-muted">Không có ai đặt món vào ngày này.</p>`;
                return;
            }

            const createTable = (data, title, badgeClass) => {
                if (Object.keys(data).length === 0) return '';
                const totalOrdered = Object.values(data).reduce((sum, curr) => sum + curr.ordered, 0);

                return `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom:10px; display:flex; align-items:center;">
                            ${title} <span class="badge ${badgeClass}">${totalOrdered} suất</span>
                        </h4>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Món ăn</th>
                                        <th class="text-center" style="width: 80px;" title="Tổng đặt"><i class="fas fa-list-ul"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data).map(([dish, d]) => `
                                        <tr>
                                            <td>${dish}</td>
                                            <td class="text-center"><b>${d.ordered}</b></td>
                                        </tr>
                                    `).join('')}
                                    <tr style="background:rgba(102,126,234,0.1); font-weight:700;">
                                        <td>TỔNG CỘNG</td>
                                        <td class="text-center">${totalOrdered}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            statsContainer.innerHTML = 
                createTable(stats.morning, 'Ca Sáng', 'badge-morning') + 
                createTable(stats.evening, 'Ca Chiều', 'badge-evening');
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                if (state.currentTab === target.dataset.tab) return;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                state.currentTab = target.dataset.tab;
                render();
            });
        });

        render();

    </script>
</body>
</html>
