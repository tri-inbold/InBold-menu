<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu - Public Monitor</title>
    
    <!-- Firebase SDK -->
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js">
    
    <!-- SheetJS (Thư viện xử lý Excel) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3cpath fill='%23f97316' d='M63.9 14.4C63.1 6.2 56.2 0 48 0s-15.1 6.2-16 14.3L17.9 149.7c-1.3 6-1.9 12.1-1.9 18.2 0 45.9 35.1 83.6 80 87.7L96 480c0 17.7 14.3 32 32 32s32-14.3 32-32l0-224.4c44.9-4.1 80-41.8 80-87.7 0-6.1-.6-12.2-1.9-18.2L223.9 14.3C223.1 6.2 216.2 0 208 0s-15.1 6.2-15.9 14.4L178.5 149.9c-.6 5.7-5.4 10.1-11.1 10.1-5.8 0-10.6-4.4-11.2-10.2L143.9 14.6C143.2 6.3 136.3 0 128 0s-15.2 6.3-15.9 14.6L99.8 149.8c-.5 5.8-5.4 10.2-11.2 10.2-5.8 0-10.6-4.4-11.1-10.1L63.9 14.4zM448 0C432 0 320 32 320 176l0 112c0 35.3 28.7 64 64 64l32 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-448c0-17.7-14.3-32-32-32z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        :root { 
            /* --- LIGHT MODE (ORANGE THEME) --- */
            --primary: #f97316;
            --primary-light: #fb923c;
            --primary-dark: #ea580c;
            --primary-bg-light: rgba(249, 115, 22, 0.1);
            
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-input: #f9fafb;
            --bg-hover: #fff7ed;
            --border: #cbd5e1;
            --text: #334155;
            --text-muted: #64748b;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius-md: 12px;
            --nav-bg: #ffffff;
        }

        /* --- DARK MODE --- */
        [data-theme="dark"] {
            --primary: #667eea;
            --primary-light: #7f9cf5;
            --primary-dark: #5a67d8;
            --primary-bg-light: rgba(102, 126, 234, 0.15);

            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: rgba(15, 23, 42, 0.5);
            --bg-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --nav-bg: #1e293b;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-body); color: var(--text); line-height: 1.5; font-size: 14px; transition: background-color 0.3s, color 0.3s; }
        #app { max-width: 900px; margin: 0 auto; min-height: 100vh; padding: 1.5rem; display: flex; flex-direction: column; position: relative; }
        
        /* --- NAV BAR DESIGN --- */
        .nav-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 1.5rem; 
        }

        .nav-bar {
            display: inline-flex;
            background: var(--nav-bg);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 5px;
            gap: 5px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-btn:hover {
            color: var(--primary);
            background: var(--bg-hover);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .theme-toggle-btn {
            width: 44px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card { background: var(--bg-card); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); transition: background-color 0.3s, border-color 0.3s; }
        
        /* Date Controls Styling */
        .date-controls-wrapper { margin-bottom: 1rem; background: var(--bg-card); padding: 10px; border-radius: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .date-nav { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; }
        .date-display { font-size: 15px; font-weight: 700; min-width: 140px; text-align: center; color: var(--primary); }
        .mini-btn { width: 36px; height: 36px; border-radius: 8px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .mini-btn:hover { background: var(--primary); color: white; border-color: transparent; }
        .excel-btn { background: #10b981; color: white; border: none; margin-left: 10px; }
        .excel-btn:hover { background: #059669; }

        .search-bar { display: flex; gap: 8px; margin-bottom: 1rem; }
        .search-wrapper { position: relative; flex: 1; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-bg-light); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .icon-btn { width: 42px; height: 42px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--primary); }

        .department-group { margin-bottom: 1.5rem; }
        .department-header { color: var(--primary); padding: 0.5rem 0; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem; }
        
        .staff-list { list-style: none; }
        .staff-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-card); border-radius: 8px; margin-bottom: 6px; border: 1px solid var(--border); transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .staff-item:hover { transform: translateY(-1px); border-color: var(--primary-light); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .staff-item.eaten { opacity: 0.6; background: var(--bg-input); box-shadow: none; }
        .staff-item.skipped { border-left: 3px solid var(--warning); background: rgba(245, 158, 11, 0.05); }
        
        .staff-name { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 3px; }
        .staff-dish { font-size: 14px; color: var(--text-muted); }
        .staff-status-icon { margin-left: 10px; font-size: 16px; width: 24px; text-align: center; }
        .status-eaten { color: var(--success); }
        .status-skip { color: var(--warning); }
        
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1rem; background: var(--bg-card); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--primary-bg-light); }
        th, td { padding: 12px 15px; text-align: left; font-size: 13px; border-bottom: 1px solid var(--border); color: var(--text); }
        th { font-weight: 600; color: var(--primary); text-transform: uppercase; font-size: 12px; }
        tr:last-child td { border-bottom: none; }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-error { color: var(--error); }
        #loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-body); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: background-color 0.3s; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 6px; }
        .badge-morning { background: rgba(66, 153, 225, 0.15); color: #3182ce; }
        .badge-evening { background: rgba(128, 90, 213, 0.15); color: #805ad5; }
        [data-theme="dark"] .badge-morning { background: rgba(66, 153, 225, 0.2); color: #63b3ed; }
        [data-theme="dark"] .badge-evening { background: rgba(128, 90, 213, 0.2); color: #b794f4; }
        
        .live-indicator { color: #ffffff; font-size: 8px; animation: pulse 2s infinite; margin-left: 6px; vertical-align: middle; position:relative; top:-1px;}
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .section-title { color: var(--text); border-bottom: 2px solid var(--primary); padding-bottom:5px; margin-bottom:15px; font-size: 18px; }

        @media (max-width: 768px) {
            #app { padding: 1rem; }
            .nav-btn { padding: 8px 16px; font-size: 13px; }
            .date-display { min-width: 100px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div style="color:var(--text); font-size: 24px; font-weight:bold; display:flex; align-items:center; gap:10px;">
            <i class="fas fa-circle-notch fa-spin" style="color:var(--primary)"></i> Loading...
        </div>
    </div>

    <div id="app">
        <!-- Unified Nav Bar -->
        <div class="nav-container">
            <div class="nav-bar">
                <button class="nav-btn active" data-tab="list">Hôm nay <i class="fas fa-circle live-indicator"></i></button>
                <button class="nav-btn" data-tab="stats">Danh sách đặt</button>
                <button id="theme-btn" class="nav-btn theme-toggle-btn" title="Đổi giao diện Sáng/Tối">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <main id="main-content"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const state = {
            currentTab: 'list', 
            viewDate: new Date(), 
            filterMode: 'auto',
            lastSearchTerm: '',
            theme: localStorage.getItem('theme') || 'light'
        };

        let unsubscribe = null;
        const el = (id) => document.getElementById(id);

        // --- Theme Logic ---
        const updateThemeUI = () => {
            document.documentElement.setAttribute('data-theme', state.theme);
            const icon = el('theme-btn').querySelector('i');
            if (state.theme === 'light') {
                icon.className = 'fas fa-moon'; 
            } else {
                icon.className = 'fas fa-sun'; 
            }
        };

        el('theme-btn').addEventListener('click', () => {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            updateThemeUI();
        });
        updateThemeUI();
        // -------------------

        const showLoader = () => el('loader').classList.remove('hidden');
        const hideLoader = () => el('loader').classList.add('hidden');

        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        
        const toLocalISOString = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            return (new Date(date - offset)).toISOString().slice(0, 10);
        };

        const parseDishValue = (rawString) => {
            if (!rawString) return { status: 'not', dish: '' };
            if (rawString.startsWith('[ignore]')) return { status: 'ignore', dish: rawString.substring(8).trim() };
            if (rawString.startsWith('giveup[')) {
                const closeBracket = rawString.indexOf(']');
                const receiver = rawString.substring(7, closeBracket);
                const dish = rawString.substring(closeBracket + 2).trim();
                return { status: 'giveup', receiver, dish };
            }
            const prefixes = ['eaten:', 'giveup:', 'not:', 'placeholder:'];
            for (const prefix of prefixes) {
                if (rawString.startsWith(prefix)) {
                    let status = prefix.replace(':', '');
                    if (status === 'placeholder') status = 'ignore';
                    return { status: status, dish: rawString.substring(prefix.length).trim() };
                }
            }
            return { status: 'not', dish: rawString };
        };

        const parseDish = (rawString) => {
            const { dish } = parseDishValue(rawString);
            if (!dish) return '';
            const parts = dish.replace('[ignore]', '').trim().split('|');
            return parts[0].trim();
        };

        function clearListener() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
        }

        // --- Export Excel (.xlsx) using SheetJS ---
        function exportToExcel(data, date) {
            const dayKey = getDayKey(date);
            const dateStr = date.toLocaleDateString('vi-VN').replace(/\//g, '-');
            
            // Lọc dữ liệu
            const orders = Object.entries(data).filter(([key, val]) => {
                return key !== 'menu' && val[dayKey] && val.order !== 'reopen';
            });

            if (orders.length === 0) {
                alert("Không có dữ liệu để tải xuống!");
                return;
            }

            // Tạo cấu trúc dữ liệu cho Excel
            const excelData = orders.map(([key, val]) => {
                const rawDish = val[dayKey];
                const { status, dish } = parseDishValue(rawDish);
                
                if (status === 'ignore') return null;

                let statusText = 'Chưa ăn';
                if (status === 'eaten') statusText = 'Đã ăn';
                if (status === 'giveup') statusText = 'Đã nhượng';

                const shift = (val.shift === 'evening' || val.shift === 'E') ? 'Chiều' : 'Sáng';
                const dishName = parseDish(rawDish).replace(/,/g, ''); 
                
                return {
                    "Tên nhân viên": val.name,
                    "Món ăn": dishName,
                    "Ca làm việc": shift,
                    "Trạng thái": statusText
                };
            }).filter(item => item !== null);

            if (excelData.length === 0) {
                alert("Không có dữ liệu hợp lệ!");
                return;
            }

            // Tạo Workbook và Worksheet
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            
            // Tự động chỉnh độ rộng cột
            const wscols = [
                {wch: 25}, // Tên
                {wch: 30}, // Món
                {wch: 10}, // Ca
                {wch: 15}  // Trạng thái
            ];
            worksheet['!cols'] = wscols;

            XLSX.utils.book_append_sheet(workbook, worksheet, "Danh sách đặt cơm");
            
            // Xuất file
            XLSX.writeFile(workbook, `Danh_sach_dat_com_${dateStr}.xlsx`);
        }

        // --- Common Components ---
        function renderDateControls(container, showExcel = false) {
            const dateStr = toLocalISOString(state.viewDate);
            const dayNames = ['Chủ nhật', 'Thứ hai', 'Thứ ba', 'Thứ tư', 'Thứ năm', 'Thứ sáu', 'Thứ bảy'];
            const dayName = dayNames[state.viewDate.getDay()];
            
            // Show Excel button if requested (now in Stats/Danh sách đặt tab)
            const excelButton = showExcel ? 
                `<button class="mini-btn excel-btn" id="export-btn" title="Tải Excel (.xlsx)"><i class="fas fa-file-excel"></i></button>` : '';

            container.innerHTML = `
                <div class="date-controls-wrapper">
                    <div class="date-nav">
                        <button class="mini-btn" id="prev-day"><i class="fas fa-chevron-left"></i></button>
                        <button class="mini-btn" id="today-btn" title="Hôm nay" style="color:var(--primary); font-weight:bold;"><i class="fas fa-calendar-day"></i></button>
                        <div style="position:relative;">
                            <div class="date-display">${dayName}, ${state.viewDate.toLocaleDateString('vi-VN')}</div>
                            <input type="date" id="date-picker" value="${dateStr}" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
                        </div>
                        <button class="mini-btn" id="next-day"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    ${excelButton}
                </div>
            `;

            el('date-picker').addEventListener('change', (e) => {
                const parts = e.target.value.split('-');
                state.viewDate = new Date(parts[0], parts[1] - 1, parts[2]);
                render(); 
            });
            el('prev-day').addEventListener('click', () => {
                state.viewDate.setDate(state.viewDate.getDate() - 1);
                render();
            });
            el('next-day').addEventListener('click', () => {
                state.viewDate.setDate(state.viewDate.getDate() + 1);
                render();
            });
            el('today-btn').addEventListener('click', () => {
                state.viewDate = new Date();
                render();
            });
            
            // Note: Event listener for export-btn is attached later in the main render function
            // because it needs the 'weekData' variable which is available only after fetching.
        }

        async function render() {
            clearListener(); 
            showLoader();
            const mainContent = el('main-content');
            mainContent.innerHTML = ''; 

            if (state.currentTab === 'list') {
                renderList(mainContent);
            } else {
                renderStats(mainContent);
            }
        }

        // --- Tab: Hôm nay (Hiển thị chi tiết nhân viên, KHÔNG có lịch) ---
        function renderList(container) {
            // Force viewDate to today when in this tab
            state.viewDate = new Date();
            const dayKey = getDayKey(state.viewDate);
            const weekString = getWeekString(state.viewDate);
            
            const headerHtml = `
                <!-- No Date Controls here -->
                <div class="search-bar">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="Tìm kiếm tên nhân viên..." value="${state.lastSearchTerm}">
                    </div>
                    <button id="toggle-filter-btn" class="icon-btn" title="Lọc ca làm việc">
                        <i class="fas ${state.filterMode === 'all' ? 'fa-list' : (new Date().getHours() < 14 ? 'fa-sun' : 'fa-moon')}"></i>
                    </button>
                </div>
                <div id="list-container"></div>
            `;
            container.innerHTML = headerHtml;

            el('search-input').addEventListener('input', (e) => {
                state.lastSearchTerm = e.target.value;
                if (window.currentWeekData) {
                    updateListView(window.currentWeekData, dayKey, state.lastSearchTerm);
                }
            });

            el('toggle-filter-btn').addEventListener('click', () => {
                state.filterMode = state.filterMode === 'auto' ? 'all' : 'auto';
                const btnIcon = el('toggle-filter-btn').querySelector('i');
                const hour = new Date().getHours();
                if (state.filterMode === 'all') {
                    btnIcon.className = 'fas fa-list';
                } else {
                    btnIcon.className = `fas ${hour < 14 ? 'fa-sun' : 'fa-moon'}`;
                }
                if (window.currentWeekData) {
                    updateListView(window.currentWeekData, dayKey, state.lastSearchTerm);
                }
            });

            const docRef = doc(db, 'order_list', weekString);
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                hideLoader();
                if (!docSnap.exists()) {
                    el('list-container').innerHTML = `<div class="card text-center text-muted">Chưa có dữ liệu cho tuần này.</div>`;
                    window.currentWeekData = null;
                    return;
                }
                
                const weekData = docSnap.data();
                window.currentWeekData = weekData; 
                // No Export button in this tab
                updateListView(weekData, dayKey, state.lastSearchTerm);
            }, (error) => {
                hideLoader();
                console.error(error);
                el('list-container').innerHTML = `<div class="card text-center text-error">Lỗi kết nối.</div>`;
            });
        }

        function updateListView(weekData, dayKey, searchTerm) {
            const container = el('list-container');
            const hour = new Date().getHours();
            
            const orders = Object.entries(weekData)
                .filter(([key, val]) => {
                    return key !== 'menu' && 
                           val[dayKey] && 
                           val.order !== 'reopen' && 
                           val.name && 
                           val.name.toLowerCase().includes(searchTerm.toLowerCase());
                })
                .map(([key, val]) => ({ ...val, key, rawDish: val[dayKey] }));

            const generateSection = (list, title) => {
                if (list.length === 0) return '';
                
                const giveupList = [];
                const notEatenList = [];
                const eatenList = [];
                
                list.forEach(o => {
                    const { status } = parseDishValue(o.rawDish);
                    if (status === 'ignore' || status === 'placeholder') return;
                    
                    if (status === 'giveup') {
                        giveupList.push(o);
                    } else if (status === 'eaten') {
                        eatenList.push(o);
                    } else {
                        notEatenList.push(o);
                    }
                });

                let html = `<div style="margin-bottom: 2rem;">
                    <h3 class="section-title">${title} <small class="text-muted" style="font-size:14px; font-weight:normal;">(${list.length})</small></h3>`;
                
                const renderGroup = (groupList, groupTitle) => {
                    if (groupList.length === 0) return '';
                    const sorted = groupList.sort((a,b) => a.name.localeCompare(b.name));
                    html += `<div class="department-group"><div class="department-header">${groupTitle}</div><ul class="staff-list">`;
                    
                    sorted.forEach(order => {
                        const { status, receiver } = parseDishValue(order.rawDish);
                        let statusClass = '';
                        let icon = '';
                        let extra = '';

                        if (status === 'eaten') {
                            statusClass = 'eaten';
                            icon = '<i class="fas fa-check-circle status-eaten"></i>';
                        } else if (status === 'giveup') {
                            statusClass = 'skipped';
                            icon = '<i class="fas fa-gift status-skip"></i>';
                            if (receiver && receiver !== 'Everyone' && receiver !== 'Mọi người') {
                                extra = `<div style="font-size:11px;color:var(--warning); margin-top:2px;"> <i class="fas fa-arrow-right"></i> ${receiver}</div>`;
                            } else {
                                extra = `<div style="font-size:11px;color:var(--warning); margin-top:2px;"> <i class="fas fa-users"></i> Đã nhượng</div>`;
                            }
                        }

                        html += `
                            <li class="staff-item ${statusClass}">
                                <div style="flex:1">
                                    <div class="staff-name">${order.name}</div>
                                    <div class="staff-dish">${parseDish(order.rawDish)}</div>
                                    ${extra}
                                </div>
                                <div class="staff-status-icon">${icon}</div>
                            </li>
                        `;
                    });
                    html += `</ul></div>`;
                };

                renderGroup(giveupList, 'Nhượng');
                renderGroup(notEatenList, 'Chưa ăn');
                renderGroup(eatenList, 'Đã ăn');
                html += `</div>`;
                return html;
            };

            const morningShift = orders.filter(o => {
                const {status} = parseDishValue(o.rawDish);
                return (status !== 'ignore') && (o.shift === 'morning' || o.shift === 'M');
            });
            
            const eveningShift = orders.filter(o => {
                const {status} = parseDishValue(o.rawDish);
                return (status !== 'ignore') && (o.shift === 'evening' || o.shift === 'E');
            });

            let contentHtml = '';
            
            if (state.filterMode === 'all') {
                contentHtml += generateSection(morningShift, '<i class="fas fa-sun" style="color:#f6e05e"></i> Ca Sáng');
                contentHtml += generateSection(eveningShift, '<i class="fas fa-moon" style="color:#805ad5"></i> Ca Chiều');
            } else {
                if (hour < 14) {
                    contentHtml += generateSection(morningShift, '<i class="fas fa-sun" style="color:#f6e05e"></i> Ca Sáng');
                    if (eveningShift.length > 0) contentHtml += `<div class="text-center text-muted" style="margin-top:20px"><small>Ca chiều sẽ hiển thị tự động sau 14:00</small></div>`;
                } else {
                    contentHtml += generateSection(eveningShift, '<i class="fas fa-moon" style="color:#805ad5"></i> Ca Chiều');
                    if (morningShift.length > 0) contentHtml += `<div class="text-center text-muted" style="margin-top:20px"><small>Xem ca sáng bằng cách bấm nút lọc phía trên</small></div>`;
                }
            }

            if (!contentHtml.trim()) {
                container.innerHTML = `<div class="card text-center text-muted">Không tìm thấy nhân viên nào đặt món.</div>`;
            } else {
                container.innerHTML = contentHtml;
            }
        }

        // --- Tab: Danh sách đặt (Hiển thị thống kê tổng hợp + CÓ lịch + CÓ Excel) ---
        function renderStats(container) {
            const dayKey = getDayKey(state.viewDate);
            const weekString = getWeekString(state.viewDate);
            
            const controlsHtml = `<div id="stats-controls"></div><div id="stats-table-container"></div>`;
            container.innerHTML = controlsHtml;

            // Render controls WITH Excel button (true)
            renderDateControls(el('stats-controls'), true);

            const docRef = doc(db, 'order_list', weekString);
            const statsContainer = el('stats-table-container');

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                hideLoader();
                if (!docSnap.exists()) {
                    statsContainer.innerHTML = `<p class="text-center text-muted">Chưa có dữ liệu cho ngày này.</p>`;
                    return;
                }
                const weekDoc = docSnap.data();
                
                // Bind Excel export now that we have data
                const exportBtn = el('export-btn');
                if(exportBtn) {
                     exportBtn.onclick = () => exportToExcel(weekDoc, state.viewDate);
                }

                updateStatsView(weekDoc, dayKey, statsContainer);
            }, (error) => {
                hideLoader();
                console.error(error);
            });
        }

        function updateStatsView(weekDoc, dayKey, statsContainer) {
            const stats = { morning: {}, evening: {} };
            let hasData = false;

            Object.entries(weekDoc).forEach(([key, val]) => {
                if (key === 'menu' || typeof val !== 'object' || !val) return;
                if (val.order === 'reopen' || !val[dayKey]) return;

                const { status } = parseDishValue(val[dayKey]);
                if (status === 'ignore' || status === 'placeholder') return;

                const dish = parseDish(val[dayKey]);
                if (!dish) return;

                const rawShift = String(val.shift || 'morning').toLowerCase().trim();
                const shiftKey = (rawShift.includes('e') || rawShift === 'evening') ? 'evening' : 'morning';

                if (!stats[shiftKey][dish]) {
                    stats[shiftKey][dish] = { ordered: 0 };
                }

                hasData = true;
                stats[shiftKey][dish].ordered++;
            });

            if (!hasData) {
                statsContainer.innerHTML = `<p class="text-center text-muted">Không có ai đặt món vào ngày này.</p>`;
                return;
            }

            const createTable = (data, title, badgeClass) => {
                if (Object.keys(data).length === 0) return '';
                const totalOrdered = Object.values(data).reduce((sum, curr) => sum + curr.ordered, 0);

                return `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom:10px; display:flex; align-items:center;">
                            ${title} <span class="badge ${badgeClass}">${totalOrdered} suất</span>
                        </h4>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Món ăn</th>
                                        <th class="text-center" style="width: 80px;"><i class="fas fa-list-ul"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data).map(([dish, d]) => `
                                        <tr>
                                            <td>${dish}</td>
                                            <td class="text-center"><b>${d.ordered}</b></td>
                                        </tr>
                                    `).join('')}
                                    <tr style="background:var(--bg-hover); font-weight:700;">
                                        <td>TỔNG CỘNG</td>
                                        <td class="text-center">${totalOrdered}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            statsContainer.innerHTML = 
                createTable(stats.morning, 'Ca Sáng', 'badge-morning') + 
                createTable(stats.evening, 'Ca Chiều', 'badge-evening');
        }

        document.querySelectorAll('.nav-btn[data-tab]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget;
                if (state.currentTab === target.dataset.tab) return;
                
                document.querySelectorAll('.nav-btn[data-tab]').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                state.currentTab = target.dataset.tab;
                render();
            });
        });

        render();

    </script>
</body>
</html>
